{% extends "base.html" %}

{% block title %}å¯¹è¯æ¨¡ç‰ˆ - AIé‡åŒ–å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .templates-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .template-list {
        max-height: 600px;
        overflow-y: auto;
    }

    .template-item {
        padding: 1rem;
        border: 1px solid #e4e7ed;
        border-radius: 8px;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .template-item:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .template-item.active {
        border-color: #667eea;
        background: #f0f5ff;
    }

    .template-name {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .template-preview {
        font-size: 0.9rem;
        color: #909399;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .template-actions {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
    }

    .template-editor textarea {
        min-height: 300px;
        font-family: 'Courier New', monospace;
    }

    .editor-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #909399;
    }

    @media (max-width: 1024px) {
        .templates-layout {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="templates-layout">
    <!-- å·¦ä¾§ï¼šæ¨¡ç‰ˆåˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">ğŸ“ æ¨¡ç‰ˆåˆ—è¡¨</div>
        <button class="btn btn-primary" onclick="showNewTemplateEditor()" style="margin-bottom: 1rem; width: 100%;">
            â• æ–°å»ºæ¨¡ç‰ˆ
        </button>
        <div class="template-list" id="templateList">
            <div class="loading">åŠ è½½ä¸­</div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ¨¡ç‰ˆç¼–è¾‘å™¨ -->
    <div class="card">
        <div class="card-header">âœï¸ æ¨¡ç‰ˆç¼–è¾‘</div>
        <div id="editorContainer">
            <div class="empty-state">â† é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªæ¨¡ç‰ˆå¼€å§‹ç¼–è¾‘</div>
        </div>
    </div>
</div>

<script>
let currentTemplate = null;

// åŠ è½½æ¨¡ç‰ˆåˆ—è¡¨
async function loadTemplates() {
    try {
        const response = await fetch('/api/templates');
        const result = await response.json();
        
        const container = document.getElementById('templateList');
        if (result.success) {
            if (result.data.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ¨¡ç‰ˆ<br>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªæ¨¡ç‰ˆ</div>';
            } else {
                container.innerHTML = result.data.map(template => `
                    <div class="template-item" onclick="selectTemplate(${template.id})">
                        <div class="template-name">${template.name}</div>
                        <div class="template-preview">${template.content.substring(0, 100)}...</div>
                        <div class="template-actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); selectTemplate(${template.id})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteTemplate(${template.id})" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }
        }
    } catch (error) {
        console.error('åŠ è½½æ¨¡ç‰ˆå¤±è´¥:', error);
    }
}

// é€‰æ‹©æ¨¡ç‰ˆ
async function selectTemplate(templateId) {
    try {
        const response = await fetch('/api/templates');
        const result = await response.json();
        
        if (result.success) {
            const template = result.data.find(t => t.id === templateId);
            if (template) {
                currentTemplate = template;
                showTemplateEditor(template);
                
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.template-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
            }
        }
    } catch (error) {
        console.error('åŠ è½½æ¨¡ç‰ˆå¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºæ–°å»ºæ¨¡ç‰ˆç¼–è¾‘å™¨
function showNewTemplateEditor() {
    currentTemplate = null;
    showTemplateEditor({
        id: null,
        name: '',
        content: ''
    });
}

// æ˜¾ç¤ºæ¨¡ç‰ˆç¼–è¾‘å™¨
function showTemplateEditor(template) {
    const container = document.getElementById('editorContainer');
    const isNew = !template.id;
    
    container.innerHTML = `
        <form id="templateForm" class="template-editor">
            <div class="input-group">
                <label>æ¨¡ç‰ˆåç§° *</label>
                <input type="text" id="templateName" value="${template.name}" required placeholder="ä¾‹å¦‚ï¼šæŠ€æœ¯åˆ†æåˆå§‹è¯æœ¯" />
            </div>
            <div class="input-group">
                <label>æ¨¡ç‰ˆå†…å®¹ *</label>
                <textarea id="templateContent" required placeholder="è¾“å…¥å¯¹è¯æ¨¡ç‰ˆå†…å®¹...">${template.content}</textarea>
            </div>
            <div class="editor-actions">
                <button type="submit" class="btn btn-primary">${isNew ? 'åˆ›å»º' : 'ä¿å­˜'}</button>
                ${isNew ? '' : '<button type="button" class="btn" onclick="cancelEdit()">å–æ¶ˆ</button>'}
            </div>
        </form>
    `;
    
    // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
    document.getElementById('templateForm').addEventListener('submit', saveTemplate);
}

// ä¿å­˜æ¨¡ç‰ˆ
async function saveTemplate(e) {
    e.preventDefault();
    
    const name = document.getElementById('templateName').value.trim();
    const content = document.getElementById('templateContent').value.trim();
    
    if (!name || !content) {
        showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
        return;
    }
    
    try {
        const isNew = !currentTemplate || !currentTemplate.id;
        const url = isNew ? '/api/templates' : `/api/templates/${currentTemplate.id}`;
        const method = isNew ? 'POST' : 'PUT';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, content })
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage(isNew ? 'åˆ›å»ºæˆåŠŸ' : 'ä¿å­˜æˆåŠŸ');
            await loadTemplates();
            if (isNew) {
                document.getElementById('editorContainer').innerHTML = '<div class="empty-state">â† é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªæ¨¡ç‰ˆå¼€å§‹ç¼–è¾‘</div>';
            }
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error');
    }
}

// åˆ é™¤æ¨¡ç‰ˆ
async function deleteTemplate(templateId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡ç‰ˆå—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/api/templates/${templateId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('åˆ é™¤æˆåŠŸ');
            await loadTemplates();
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç¼–è¾‘çš„æ¨¡ç‰ˆï¼Œæ¸…ç©ºç¼–è¾‘å™¨
            if (currentTemplate && currentTemplate.id === templateId) {
                currentTemplate = null;
                document.getElementById('editorContainer').innerHTML = '<div class="empty-state">â† é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªæ¨¡ç‰ˆå¼€å§‹ç¼–è¾‘</div>';
            }
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit() {
    currentTemplate = null;
    document.getElementById('editorContainer').innerHTML = '<div class="empty-state">â† é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªæ¨¡ç‰ˆå¼€å§‹ç¼–è¾‘</div>';
    document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('active');
    });
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', () => {
    loadTemplates();
});
</script>
{% endblock %}
