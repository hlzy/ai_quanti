{% extends "base.html" %}

{% block title %}è‚¡ç¥¨åˆ†æ - AIé‡åŒ–å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .main-layout {
        display: grid;
        grid-template-columns: 300px 1fr 400px;
        gap: 1.5rem;
        height: calc(100vh - 180px);
    }

    .watchlist-panel {
        overflow-y: auto;
    }

    .stock-item {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
    }

    .stock-item:hover {
        background: #f8f9fa;
    }

    .stock-item.active {
        background: #e8f4ff;
        border-left: 3px solid #667eea;
    }

    .stock-code {
        font-weight: 600;
        color: #667eea;
    }

    .stock-name {
        font-size: 0.85rem;
        color: #909399;
        margin-top: 0.25rem;
    }

    .add-stock-form {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .add-stock-form input {
        flex: 1;
    }

    .chart-panel {
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        min-height: 250px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .chart-title {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .chart-placeholder {
        text-align: center;
        padding: 3rem;
        color: #909399;
    }

    .chat-panel {
        display: flex;
        flex-direction: column;
    }

    .chat-history {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #e4e7ed;
        border-radius: 5px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fafafa;
        min-height: 400px;
        max-height: 600px;
        resize: vertical;
    }

    /* å¯¹è¯ç»„ï¼ˆç”¨æˆ·é—®é¢˜ + AIå›å¤ï¼‰ */
    .chat-group {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
    }

    .chat-message {
        margin-bottom: 0.5rem;
        padding: 0.8rem;
        border-radius: 8px;
        position: relative;
        display: block;
        width: fit-content;
    }

    .chat-message.user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        margin-right: 0;
        max-width: 80%;
        border-radius: 12px 12px 0 12px;
        align-self: flex-end;
    }

    .chat-message.assistant {
        background: white;
        border: 1px solid #e4e7ed;
        margin-left: 0;
        margin-right: auto;
        max-width: 90%;
        border-radius: 12px 12px 12px 0;
        line-height: 1.6;
        align-self: flex-start;
    }

    .chat-time {
        font-size: 0.7rem;
        opacity: 0.6;
        margin-top: 0.3rem;
        text-align: right;
    }

    .chat-message.user .chat-time {
        color: rgba(255, 255, 255, 0.8);
    }

    .chat-message.assistant .chat-time {
        color: #909399;
    }
    
    /* Markdownæ ·å¼ */
    .markdown-content h1, .markdown-content h2, .markdown-content h3,
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .markdown-content h1 { font-size: 1.5rem; }
    .markdown-content h2 { font-size: 1.3rem; }
    .markdown-content h3 { font-size: 1.1rem; }
    
    .markdown-content p {
        margin-bottom: 0.8rem;
        line-height: 1.6;
    }
    
    .markdown-content ul, .markdown-content ol {
        margin-left: 1.5rem;
        margin-bottom: 0.8rem;
    }
    
    .markdown-content li {
        margin-bottom: 0.3rem;
        line-height: 1.5;
    }
    
    .markdown-content code {
        background: #f5f5f5;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    .markdown-content pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
        margin-bottom: 0.8rem;
    }
    
    .markdown-content pre code {
        background: none;
        padding: 0;
    }
    
    .markdown-content blockquote {
        border-left: 4px solid #ddd;
        padding-left: 1rem;
        margin: 0.8rem 0;
        color: #666;
    }
    
    .markdown-content strong {
        font-weight: 600;
        color: #333;
    }
    
    .markdown-content em {
        font-style: italic;
    }
    
    .markdown-content hr {
        border: none;
        border-top: 1px solid #e4e7ed;
        margin: 1rem 0;
    }
    
    .markdown-content table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 0.8rem;
    }
    
    .markdown-content table th,
    .markdown-content table td {
        border: 1px solid #ddd;
        padding: 0.5rem;
        text-align: left;
    }
    
    .markdown-content table th {
        background: #f5f5f5;
        font-weight: 600;
    }

    .chat-input-area {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input-area textarea {
        flex: 1;
        min-height: 80px;
        resize: vertical;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #909399;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .data-table th, .data-table td {
        padding: 0.5rem;
        border: 1px solid #e4e7ed;
        text-align: right;
    }

    .data-table th {
        background: #f5f7fa;
        font-weight: 600;
    }

    .positive {
        color: #67c23a;
    }

    .negative {
        color: #f56c6c;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-layout">
    <!-- å·¦ä¾§ï¼šè‡ªé€‰è‚¡ -->
    <div class="watchlist-panel">
        <div class="card">
            <div class="card-header">ğŸ“Š è‡ªé€‰è‚¡</div>
            <div class="add-stock-form">
                <input type="text" id="newStockCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç " />
                <button class="btn btn-primary" onclick="addToWatchlist()">æ·»åŠ </button>
            </div>
            <div id="watchlistContainer">
                <div class="loading">åŠ è½½ä¸­</div>
            </div>
        </div>
    </div>

    <!-- ä¸­é—´ï¼šè‚¡ç¥¨é¢„è§ˆï¼ˆKçº¿å›¾ï¼‰ -->
    <div class="chart-panel">
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="card">
            <div class="card-header">
                <span id="currentStockTitle">é€‰æ‹©ä¸€åªè‚¡ç¥¨å¼€å§‹åˆ†æ</span>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="updateStockData()" id="updateBtn" disabled>æ›´æ–°æ•°æ®</button>
            </div>
        </div>
        
        <!-- 1åˆ†é’ŸKçº¿å›¾ -->
        <div class="card chart-container">
            <div class="chart-header">
                <span class="chart-title">ğŸ“ˆ 1åˆ†é’ŸKçº¿ï¼ˆ2å¤©çª—å£ï¼‰</span>
            </div>
            <div id="minuteChart" style="width: 100%; height: 300px;"></div>
        </div>
        
        <!-- æ—¥Kçº¿å›¾ -->
        <div class="card chart-container">
            <div class="chart-header">
                <span class="chart-title">ğŸ“Š æ—¥Kçº¿ï¼ˆ60å¤©çª—å£ï¼‰</span>
            </div>
            <div id="dailyChart" style="width: 100%; height: 350px;"></div>
        </div>
        
        <!-- å‘¨Kçº¿å›¾ -->
        <div class="card chart-container">
            <div class="chart-header">
                <span class="chart-title">ğŸ“‰ å‘¨Kçº¿ï¼ˆ360å¤©çª—å£ï¼‰</span>
            </div>
            <div id="weeklyChart" style="width: 100%; height: 350px;"></div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šAIå¯¹è¯ -->
    <div class="chat-panel">
        <div class="card" style="flex: 1; display: flex; flex-direction: column;">
            <div class="card-header">
                ğŸ’¬ AIå¯¹è¯è®°å½•
                <button class="btn btn-danger" onclick="clearChat()" style="float: right; font-size: 0.85rem; padding: 0.4rem 0.8rem;" id="clearChatBtn" disabled>æ¸…é™¤</button>
            </div>
            <div class="chat-history" id="chatHistory">
                <div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>
            </div>
            <div class="chat-input-area">
                <textarea id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn" disabled>å‘é€</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStock = null;

// åŠ è½½è‡ªé€‰è‚¡
async function loadWatchlist() {
    try {
        const response = await fetch('/api/watchlist');
        const result = await response.json();
        
        if (result.success) {
            const container = document.getElementById('watchlistContainer');
            if (result.data.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— è‡ªé€‰è‚¡</div>';
            } else {
                container.innerHTML = result.data.map(stock => `
                    <div class="stock-item" onclick="selectStock('${stock.stock_code}', '${stock.stock_name}')">
                        <div class="stock-code">${stock.stock_code}</div>
                        <div class="stock-name">${stock.stock_name || ''}</div>
                    </div>
                `).join('');
            }
        }
    } catch (error) {
        console.error('åŠ è½½è‡ªé€‰è‚¡å¤±è´¥:', error);
    }
}

// æ·»åŠ è‡ªé€‰è‚¡
async function addToWatchlist() {
    const input = document.getElementById('newStockCode');
    const stockCode = input.value.trim();
    
    if (!stockCode) {
        showMessage('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/watchlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock_code: stockCode })
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('æ·»åŠ æˆåŠŸ');
            input.value = '';
            loadWatchlist();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
    }
}

// é€‰æ‹©è‚¡ç¥¨
async function selectStock(stockCode, stockName) {
    currentStock = { code: stockCode, name: stockName };
    
    // æ›´æ–°UI
    document.querySelectorAll('.stock-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    document.getElementById('currentStockTitle').textContent = `${stockName} (${stockCode})`;
    document.getElementById('updateBtn').disabled = false;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('clearChatBtn').disabled = false;
    
    // åŠ è½½Kçº¿æ•°æ®
    await loadKlineCharts();
    await loadChatHistory();
}

// åŠ è½½Kçº¿å›¾æ•°æ®
async function loadKlineCharts() {
    if (!currentStock) return;
    
    try {
        // å¹¶è¡ŒåŠ è½½ä¸‰ç§å‘¨æœŸçš„æ•°æ®
        const [minuteRes, dailyRes, weeklyRes] = await Promise.all([
            fetch(`/api/stock/data/${currentStock.code}?period=minute&days=1440`),
            fetch(`/api/stock/data/${currentStock.code}?period=daily&days=60`),
            fetch(`/api/stock/data/${currentStock.code}?period=weekly&days=52`)
        ]);
        
        const minuteResult = await minuteRes.json();
        const dailyResult = await dailyRes.json();
        const weeklyResult = await weeklyRes.json();
        
        // æ¸²æŸ“å›¾è¡¨
        if (minuteResult.success && minuteResult.data.length > 0) {
            renderKlineChart('minuteChart', minuteResult.data, '1åˆ†é’ŸKçº¿');
        }
        
        if (dailyResult.success && dailyResult.data.length > 0) {
            renderKlineChart('dailyChart', dailyResult.data, 'æ—¥Kçº¿');
        }
        
        if (weeklyResult.success && weeklyResult.data.length > 0) {
            renderKlineChart('weeklyChart', weeklyResult.data, 'å‘¨Kçº¿');
        }
    } catch (error) {
        console.error('åŠ è½½Kçº¿æ•°æ®å¤±è´¥:', error);
        showMessage('åŠ è½½Kçº¿æ•°æ®å¤±è´¥', 'error');
    }
}

// æ¸²æŸ“Kçº¿å›¾
function renderKlineChart(containerId, data, title) {
    const container = document.getElementById(containerId);
    const chart = echarts.init(container);
    
    // å‡†å¤‡æ•°æ®
    const dates = data.map(d => {
        if (d.trade_time) {
            // åˆ†é’Ÿæ•°æ®
            const dt = new Date(d.trade_time);
            return `${dt.getMonth()+1}/${dt.getDate()} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
        } else {
            // æ—¥K/å‘¨Kæ•°æ®
            return formatDate(d.trade_date);
        }
    });
    
    const ohlc = data.map(d => [d.open, d.close, d.low, d.high]);
    const volumes = data.map(d => d.volume || 0);
    
    // é…ç½®é¡¹
    const option = {
        animation: false,
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            },
            formatter: function(params) {
                let result = params[0].name + '<br/>';
                const candleData = params[0].data;
                result += 'å¼€ç›˜: ' + candleData[1].toFixed(2) + '<br/>';
                result += 'æ”¶ç›˜: ' + candleData[2].toFixed(2) + '<br/>';
                result += 'æœ€ä½: ' + candleData[3].toFixed(2) + '<br/>';
                result += 'æœ€é«˜: ' + candleData[4].toFixed(2) + '<br/>';
                if (params[1]) {
                    result += 'æˆäº¤é‡: ' + (params[1].data / 10000).toFixed(2) + 'ä¸‡';
                }
                return result;
            }
        },
        grid: [
            {
                left: '5%',
                right: '5%',
                top: '10%',
                height: '60%'
            },
            {
                left: '5%',
                right: '5%',
                top: '75%',
                height: '15%'
            }
        ],
        xAxis: [
            {
                type: 'category',
                data: dates,
                scale: true,
                boundaryGap: false,
                axisLine: { onZero: false },
                splitLine: { show: false },
                splitNumber: 20,
                axisLabel: {
                    rotate: 45,
                    interval: Math.floor(dates.length / 10)
                }
            },
            {
                type: 'category',
                gridIndex: 1,
                data: dates,
                scale: true,
                boundaryGap: false,
                axisLine: { onZero: false },
                axisTick: { show: false },
                splitLine: { show: false },
                axisLabel: { show: false }
            }
        ],
        yAxis: [
            {
                scale: true,
                splitArea: {
                    show: true
                }
            },
            {
                scale: true,
                gridIndex: 1,
                splitNumber: 2,
                axisLabel: { show: false },
                axisLine: { show: false },
                axisTick: { show: false },
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            {
                type: 'inside',
                xAxisIndex: [0, 1],
                start: 0,
                end: 100
            },
            {
                show: true,
                xAxisIndex: [0, 1],
                type: 'slider',
                top: '90%',
                start: 0,
                end: 100
            }
        ],
        series: [
            {
                name: title,
                type: 'candlestick',
                data: ohlc,
                itemStyle: {
                    color: '#ef5350',
                    color0: '#26a69a',
                    borderColor: '#ef5350',
                    borderColor0: '#26a69a'
                }
            },
            {
                name: 'æˆäº¤é‡',
                type: 'bar',
                xAxisIndex: 1,
                yAxisIndex: 1,
                data: volumes,
                itemStyle: {
                    color: function(params) {
                        const index = params.dataIndex;
                        const candleData = ohlc[index];
                        return candleData[1] > candleData[2] ? '#26a69a' : '#ef5350';
                    }
                }
            }
        ]
    };
    
    chart.setOption(option);
    
    // å“åº”å¼è°ƒæ•´
    window.addEventListener('resize', () => {
        chart.resize();
    });
    
    // æ”¯æŒé”®ç›˜ç¼©æ”¾
    container.tabIndex = 0;  // ä½¿divå¯èšç„¦
    container.addEventListener('keydown', (e) => {
        const currentZoom = chart.getOption().dataZoom[0];
        const range = currentZoom.end - currentZoom.start;
        
        if (e.key === 'ArrowUp') {
            // æ”¾å¤§ï¼ˆç¼©å°èŒƒå›´ï¼‰
            e.preventDefault();
            const newRange = Math.max(range * 0.8, 5);
            const center = (currentZoom.start + currentZoom.end) / 2;
            chart.dispatchAction({
                type: 'dataZoom',
                start: Math.max(center - newRange / 2, 0),
                end: Math.min(center + newRange / 2, 100)
            });
        } else if (e.key === 'ArrowDown') {
            // ç¼©å°ï¼ˆæ‰©å¤§èŒƒå›´ï¼‰
            e.preventDefault();
            const newRange = Math.min(range * 1.25, 100);
            const center = (currentZoom.start + currentZoom.end) / 2;
            chart.dispatchAction({
                type: 'dataZoom',
                start: Math.max(center - newRange / 2, 0),
                end: Math.min(center + newRange / 2, 100)
            });
        }
    });
}


// æ›´æ–°è‚¡ç¥¨æ•°æ®
async function updateStockData() {
    if (!currentStock) return;
    
    const btn = document.getElementById('updateBtn');
    btn.disabled = true;
    btn.textContent = 'æ›´æ–°ä¸­...';
    
    try {
        const response = await fetch(`/api/stock/update/${currentStock.code}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('æ•°æ®æ›´æ–°æˆåŠŸ');
            await loadKlineCharts();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'æ›´æ–°æ•°æ®';
    }
}


// åŠ è½½èŠå¤©è®°å½• - å°†ç”¨æˆ·é—®é¢˜å’ŒAIå›å¤ç»„åˆåœ¨ä¸€èµ·
async function loadChatHistory() {
    if (!currentStock) return;
    
    try {
        const response = await fetch(`/api/chat/history/${currentStock.code}`);
        const result = await response.json();
        
        const container = document.getElementById('chatHistory');
        if (result.success && result.data.length > 0) {
            // æŒ‰å¯¹è¯ç»„ç»‡æ¶ˆæ¯ï¼šæ¯ä¸ªç”¨æˆ·æ¶ˆæ¯åè·ŸéšAIå›å¤
            const messages = result.data;
            let html = '';
            
            // æŒ‰æ—¶é—´åˆ†ç»„å¯¹è¯
            let i = 0;
            while (i < messages.length) {
                const msg = messages[i];
                
                if (msg.role === 'user') {
                    // å¼€å§‹ä¸€ä¸ªæ–°çš„å¯¹è¯ç»„ - ç”¨æˆ·é—®é¢˜åœ¨ä¸Š
                    html += '<div class="chat-group">';
                    html += `
                        <div class="chat-message user">
                            <div>${escapeHtml(msg.content)}</div>
                            <div class="chat-time">${formatDateTime(msg.created_at)}</div>
                        </div>
                    `;
                    
                    // æŸ¥æ‰¾ç´§éšå…¶åçš„AIå›å¤
                    if (i + 1 < messages.length && messages[i + 1].role === 'assistant') {
                        const aiMsg = messages[i + 1];
                        html += `
                            <div class="chat-message assistant">
                                ${renderMarkdown(aiMsg.content)}
                                <div class="chat-time">${formatDateTime(aiMsg.created_at)}</div>
                            </div>
                        `;
                        i++; // è·³è¿‡å·²å¤„ç†çš„AIæ¶ˆæ¯
                    }
                    
                    html += '</div>'; // ç»“æŸå¯¹è¯ç»„
                } else if (msg.role === 'assistant') {
                    // å•ç‹¬çš„AIæ¶ˆæ¯ï¼ˆå¦‚AIåˆ†æï¼‰ï¼Œæ²¡æœ‰é…å¯¹çš„ç”¨æˆ·é—®é¢˜
                    html += `
                        <div class="chat-group">
                            <div class="chat-message assistant">
                                ${renderMarkdown(msg.content)}
                                <div class="chat-time">${formatDateTime(msg.created_at)}</div>
                            </div>
                        </div>
                    `;
                }
                
                i++;
            }
            
            container.innerHTML = html;
            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        } else {
            container.innerHTML = '<div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>';
        }
    } catch (error) {
        console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
    }
}

// HTMLè½¬ä¹‰å‡½æ•°ï¼ˆç”¨äºç”¨æˆ·è¾“å…¥ï¼‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ - 2026/2/18 16:46:12
function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
}

// æ¸²æŸ“Markdownå†…å®¹
function renderMarkdown(content) {
    if (!content) return '';
    
    // é…ç½®markedé€‰é¡¹
    marked.setOptions({
        breaks: true,        // æ”¯æŒæ¢è¡Œ
        gfm: true,          // æ”¯æŒGitHubé£æ ¼çš„Markdown
        headerIds: false,   // ä¸ç”Ÿæˆheader id
        mangle: false       // ä¸æ··æ·†é‚®ç®±åœ°å€
    });
    
    // æ¸²æŸ“Markdown
    const html = marked.parse(content);
    
    // åŒ…è£¹åœ¨markdown-contentç±»ä¸­
    return `<div class="markdown-content">${html}</div>`;
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    if (!currentStock) return;
    
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) {
        showMessage('è¯·è¾“å…¥æ¶ˆæ¯', 'error');
        return;
    }
    
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    btn.textContent = 'å‘é€ä¸­...';
    
    // ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    const container = document.getElementById('chatHistory');
    const userMsgHtml = `
        <div class="chat-group" id="temp-msg">
            <div class="chat-message user">
                <div>${escapeHtml(message)}</div>
                <div class="chat-time">${formatDateTime(new Date())}</div>
            </div>
            <div class="chat-message assistant">
                <div class="markdown-content"><p><em>AIæ­£åœ¨æ€è€ƒä¸­...</em></p></div>
            </div>
        </div>
    `;
    
    // å¦‚æœæœ‰ç©ºçŠ¶æ€æç¤ºï¼Œå…ˆæ¸…é™¤
    if (container.querySelector('.empty-state')) {
        container.innerHTML = '';
    }
    
    container.insertAdjacentHTML('beforeend', userMsgHtml);
    container.scrollTop = container.scrollHeight;
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    try {
        const response = await fetch('/api/chat/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stock_code: currentStock.code,
                message: message
            })
        });
        
        const result = await response.json();
        if (result.success) {
            // é‡æ–°åŠ è½½å®Œæ•´çš„èŠå¤©è®°å½•ï¼ˆåŒ…å«çœŸå®çš„AIå›å¤ï¼‰
            await loadChatHistory();
        } else {
            // åˆ é™¤ä¸´æ—¶æ¶ˆæ¯å¹¶æ˜¾ç¤ºé”™è¯¯
            document.getElementById('temp-msg')?.remove();
            showMessage(result.message, 'error');
        }
    } catch (error) {
        // åˆ é™¤ä¸´æ—¶æ¶ˆæ¯å¹¶æ˜¾ç¤ºé”™è¯¯
        document.getElementById('temp-msg')?.remove();
        showMessage('å‘é€å¤±è´¥: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'å‘é€';
    }
}

// æ¸…é™¤èŠå¤©è®°å½•
async function clearChat() {
    if (!currentStock) return;
    
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/api/chat/clear/${currentStock.code}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('èŠå¤©è®°å½•å·²æ¸…é™¤');
            await loadChatHistory();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', () => {
    loadWatchlist();
    
    // å›è½¦æ¢è¡Œï¼ŒShift+å›è½¦å‘é€æ¶ˆæ¯
    const chatInput = document.getElementById('chatInput');
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.shiftKey) {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            sendMessage();
        }
        // å•ç‹¬æŒ‰å›è½¦ä¼šä¿æŒé»˜è®¤è¡Œä¸ºï¼ˆæ¢è¡Œï¼‰
    });
});
</script>
{% endblock %}
