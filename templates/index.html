{% extends "base.html" %}

{% block title %}è‚¡ç¥¨åˆ†æ - AIé‡åŒ–å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .main-layout {
        display: grid;
        grid-template-columns: 300px 1fr 400px;
        gap: 1.5rem;
        height: calc(100vh - 180px);
    }

    .watchlist-panel {
        overflow-y: auto;
    }

    .stock-item {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
    }

    .stock-item:hover {
        background: #f8f9fa;
    }

    .stock-item.active {
        background: #e8f4ff;
        border-left: 3px solid #667eea;
    }

    .stock-code {
        font-weight: 600;
        color: #667eea;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stock-type-badge {
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
        border-radius: 3px;
        font-weight: 500;
    }

    .stock-type-stock {
        background: #e8f4ff;
        color: #667eea;
    }

    .stock-type-index {
        background: #fff3e0;
        color: #ff9800;
    }

    .stock-type-fund {
        background: #e8f5e9;
        color: #4caf50;
    }

    .stock-name {
        font-size: 0.85rem;
        color: #909399;
        margin-top: 0.25rem;
    }

    .add-stock-form {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .add-stock-form input {
        flex: 1;
    }

    .chart-panel {
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        min-height: 250px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .chart-title {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .chart-placeholder {
        text-align: center;
        padding: 3rem;
        color: #909399;
    }

    .chat-panel {
        display: flex;
        flex-direction: column;
    }

    .chat-history {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #e4e7ed;
        border-radius: 5px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fafafa;
        min-height: 400px;
        max-height: 600px;
        resize: vertical;
    }

    /* å¯¹è¯ç»„ï¼ˆç”¨æˆ·é—®é¢˜ + AIå›å¤ï¼‰ */
    .chat-group {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
    }

    .chat-message {
        margin-bottom: 0.5rem;
        padding: 0.8rem;
        border-radius: 8px;
        position: relative;
        display: block;
        width: fit-content;
    }

    .chat-message.user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        margin-right: 0;
        max-width: 80%;
        border-radius: 12px 12px 0 12px;
        align-self: flex-end;
    }

    .chat-message.assistant {
        background: white;
        border: 1px solid #e4e7ed;
        margin-left: 0;
        margin-right: auto;
        max-width: 90%;
        border-radius: 12px 12px 12px 0;
        line-height: 1.6;
        align-self: flex-start;
    }

    .chat-time {
        font-size: 0.7rem;
        opacity: 0.6;
        margin-top: 0.3rem;
        text-align: right;
    }

    .chat-message.user .chat-time {
        color: rgba(255, 255, 255, 0.8);
    }

    .chat-message.assistant .chat-time {
        color: #909399;
    }
    
    /* Markdownæ ·å¼ */
    .markdown-content h1, .markdown-content h2, .markdown-content h3,
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .markdown-content h1 { font-size: 1.5rem; }
    .markdown-content h2 { font-size: 1.3rem; }
    .markdown-content h3 { font-size: 1.1rem; }
    
    .markdown-content p {
        margin-bottom: 0.8rem;
        line-height: 1.6;
    }
    
    .markdown-content ul, .markdown-content ol {
        margin-left: 1.5rem;
        margin-bottom: 0.8rem;
    }
    
    .markdown-content li {
        margin-bottom: 0.3rem;
        line-height: 1.5;
    }
    
    .markdown-content code {
        background: #f5f5f5;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    .markdown-content pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
        margin-bottom: 0.8rem;
    }
    
    .markdown-content pre code {
        background: none;
        padding: 0;
    }
    
    .markdown-content blockquote {
        border-left: 4px solid #ddd;
        padding-left: 1rem;
        margin: 0.8rem 0;
        color: #666;
    }
    
    .markdown-content strong {
        font-weight: 600;
        color: #333;
    }
    
    .markdown-content em {
        font-style: italic;
    }
    
    .markdown-content hr {
        border: none;
        border-top: 1px solid #e4e7ed;
        margin: 1rem 0;
    }
    
    .markdown-content table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 0.8rem;
    }
    
    .markdown-content table th,
    .markdown-content table td {
        border: 1px solid #ddd;
        padding: 0.5rem;
        text-align: left;
    }
    
    .markdown-content table th {
        background: #f5f5f5;
        font-weight: 600;
    }

    .chat-input-area {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input-area textarea {
        flex: 1;
        min-height: 80px;
        resize: vertical;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #909399;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .data-table th, .data-table td {
        padding: 0.5rem;
        border: 1px solid #e4e7ed;
        text-align: right;
    }

    .data-table th {
        background: #f5f7fa;
        font-weight: 600;
    }

    .positive {
        color: #67c23a;
    }

    .negative {
        color: #f56c6c;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 10px;
        width: 80%;
        max-width: 700px;
        max-height: 80%;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e4e7ed;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.3rem;
        color: #303133;
    }

    .close {
        font-size: 1.8rem;
        font-weight: bold;
        color: #909399;
        cursor: pointer;
        line-height: 1;
    }

    .close:hover {
        color: #606266;
    }

    .template-item {
        padding: 1rem;
        border: 1px solid #e4e7ed;
        border-radius: 5px;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .template-item:hover {
        background: #f8f9fa;
        border-color: #667eea;
    }

    .template-name {
        font-weight: 600;
        color: #303133;
        margin-bottom: 0.5rem;
    }

    .template-content {
        font-size: 0.9rem;
        color: #606266;
        white-space: pre-wrap;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .variable-help-section {
        margin-bottom: 1.5rem;
    }

    .variable-help-section h3 {
        font-size: 1.1rem;
        color: #303133;
        margin-bottom: 0.8rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e4e7ed;
    }

    .variable-example {
        background: #f5f7fa;
        padding: 0.8rem;
        border-radius: 5px;
        margin-bottom: 0.8rem;
        font-family: 'Courier New', monospace;
    }

    .variable-format {
        background: #fff3e0;
        padding: 0.8rem;
        border-radius: 5px;
        border-left: 4px solid #ff9800;
        margin-bottom: 0.8rem;
    }

    .variable-format strong {
        color: #f57c00;
    }

    .param-list {
        margin-left: 1.5rem;
    }

    .param-list li {
        margin-bottom: 0.5rem;
        color: #606266;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-layout">
    <!-- å·¦ä¾§ï¼šè‡ªé€‰è‚¡ -->
    <div class="watchlist-panel">
        <div class="card">
            <div class="card-header">ğŸ“Š è‡ªé€‰è‚¡</div>
            <div class="add-stock-form">
                <input type="text" id="newStockCode" placeholder="ä»£ç (Aè‚¡/æŒ‡æ•°/ETF)" />
                <button class="btn btn-primary" onclick="addToWatchlist()">æ·»åŠ </button>
            </div>
            <div id="watchlistContainer">
                <div class="loading">åŠ è½½ä¸­</div>
            </div>
        </div>
    </div>

    <!-- ä¸­é—´ï¼šè‚¡ç¥¨é¢„è§ˆï¼ˆKçº¿å›¾ï¼‰ -->
    <div class="chart-panel">
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="card">
            <div class="card-header">
                <span id="currentStockTitle">é€‰æ‹©ä¸€åªè‚¡ç¥¨å¼€å§‹åˆ†æ</span>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="updateStockData()" id="updateBtn" disabled>æ›´æ–°æ•°æ®</button>
            </div>
        </div>
        
        <!-- 1åˆ†é’ŸKçº¿å›¾ -->
        <div class="card chart-container">
            <div class="chart-header">
                <span class="chart-title">ğŸ“ˆ 1åˆ†é’ŸKçº¿ï¼ˆ2å¤©çª—å£ï¼‰</span>
            </div>
            <div id="minuteChart" style="width: 100%; height: 300px;"></div>
        </div>
        
        <!-- æ—¥Kçº¿å›¾ -->
        <div class="card chart-container">
            <div class="chart-header">
                <span class="chart-title">ğŸ“Š æ—¥Kçº¿ï¼ˆ60å¤©çª—å£ï¼‰</span>
            </div>
            <div id="dailyChart" style="width: 100%; height: 350px;"></div>
        </div>
        
        <!-- å‘¨Kçº¿å›¾ -->
        <div class="card chart-container">
            <div class="chart-header">
                <span class="chart-title">ğŸ“‰ å‘¨Kçº¿ï¼ˆ360å¤©çª—å£ï¼‰</span>
            </div>
            <div id="weeklyChart" style="width: 100%; height: 350px;"></div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šAIå¯¹è¯ -->
    <div class="chat-panel">
        <div class="card" style="flex: 1; display: flex; flex-direction: column;">
            <div class="card-header">
                ğŸ’¬ AIå¯¹è¯è®°å½•
                <button class="btn btn-info" onclick="showVariablesHelp()" style="float: right; font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-left: 0.5rem;" id="helpBtn" disabled title="å˜é‡è¯´æ˜">?</button>
                <button class="btn btn-danger" onclick="clearChat()" style="float: right; font-size: 0.85rem; padding: 0.4rem 0.8rem;" id="clearChatBtn" disabled>æ¸…é™¤</button>
            </div>
            <div class="chat-history" id="chatHistory">
                <div class="empty-state">
                    <p style="margin-bottom: 1rem;">æš‚æ— å¯¹è¯è®°å½•</p>
                    <button class="btn btn-primary" onclick="showTemplateSelector()" id="selectTemplateBtn" disabled>é€‰æ‹©å¯¹è¯æ¨¡ç‰ˆ</button>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn" disabled>å‘é€</button>
            </div>
        </div>
    </div>
</div>

<!-- å˜é‡å¸®åŠ©æ¨¡æ€æ¡† -->
<div id="variablesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“š å¯ç”¨å˜é‡è¯´æ˜</h2>
            <span class="close" onclick="closeVariablesModal()">&times;</span>
        </div>
        
        <div class="variable-help-section">
            <h3>å˜é‡æ ¼å¼</h3>
            <div class="variable-format">
                <strong>1. Kçº¿æ•°æ®ï¼šKçº¿ç±»å‹_è‚¡ç¥¨_çª—å£_æŒ‡æ ‡</strong>
            </div>
            <p style="color: #606266; line-height: 1.6;">
                å˜é‡å°†è‡ªåŠ¨è¾“å‡ºKçº¿å…³è”çš„ï¼š<strong>æ—¥æœŸã€å¼€ç›˜ã€æ”¶ç›˜ã€æœ€é«˜ã€æœ€ä½ã€æˆäº¤é‡</strong>ã€‚
                å¦‚æœæŒ‡æ ‡å‚æ•°æœ‰å¤šä¸ªæŒ‡æ ‡ï¼Œåˆ™ä¹Ÿè®¡ç®—ç›¸å…³æŒ‡æ ‡ä½œä¸ºè¾“å‡ºã€‚
            </p>
            
            <div class="variable-format" style="margin-top: 1rem;">
                <strong>2. ä»“ä½ä¿¡æ¯ï¼šæŒä»“ / å¯ç”¨èµ„é‡‘</strong>
            </div>
            <p style="color: #606266; line-height: 1.6;">
                <strong>æŒä»“</strong>ï¼šæ˜¾ç¤ºæ‰€æœ‰æŒä»“è‚¡ç¥¨çš„è¯¦ç»†ä¿¡æ¯ï¼ˆä»£ç ã€åç§°ã€æ•°é‡ã€æˆæœ¬ã€å½“å‰ä»·ã€ç›ˆäºç­‰ï¼‰åŠæ±‡æ€»æ•°æ®ã€‚<br>
                <strong>å¯ç”¨èµ„é‡‘</strong>ï¼šæ˜¾ç¤ºè´¦æˆ·å¯ç”¨ç°é‡‘ä½™é¢ã€‚
            </p>
        </div>

        <div class="variable-help-section">
            <h3>å‚æ•°è¯´æ˜</h3>
            <ul class="param-list">
                <li><strong>Kçº¿ç±»å‹</strong>ï¼ˆå¿…å¡«ï¼‰ï¼š1åˆ†é’ŸKã€æ—¥Kã€å‘¨K</li>
                <li><strong>è‚¡ç¥¨</strong>ï¼ˆé€‰å¡«ï¼‰ï¼šAè‚¡ã€æŒ‡æ•°ã€ETFçš„ä»£ç æˆ–åç§°ï¼Œä¸å¡«åˆ™è¡¨ç¤ºå½“å‰é€‰ä¸­çš„è‚¡ç¥¨</li>
                <li><strong>çª—å£</strong>ï¼ˆé€‰å¡«ï¼‰ï¼šå•ä½æ˜¯å¤©æ•°ï¼Œå¦‚ "1å¤©"ã€"3å¤©"ã€‚é»˜è®¤ï¼šæ—¥K=60å¤©ï¼Œå‘¨K=360å¤©ï¼Œ1åˆ†é’ŸK=2å¤©</li>
                <li><strong>æŒ‡æ ‡</strong>ï¼ˆé€‰å¡«ã€å¯å¤šä¸ªç”¨&åˆ†å‰²ï¼‰ï¼šå¦‚ "MACD"ã€"EMA"ã€"RSI" ç­‰ã€‚å¤šä¸ªæŒ‡æ ‡ç”¨ "&" åˆ†å‰²ï¼Œå¦‚ "MACD&EMA"</li>
            </ul>
        </div>

        <div class="variable-help-section">
            <h3>ç¤ºä¾‹</h3>
            
            <h4 style="font-size: 1rem; color: #667eea; margin-top: 1rem;">Kçº¿æ•°æ®ç¤ºä¾‹</h4>
            <div class="variable-example">
                æ—¥K_å¤æ—¦å¾®ç”µ_30å¤©_MACD&EMA
            </div>
            <p style="color: #606266; line-height: 1.6;">
                è¡¨ç¤ºï¼šä½¿ç”¨æ—¥Kçº¿ï¼Œè‚¡ç¥¨ä»£ç æ˜¯688385ï¼ˆå¤æ—¦å¾®ç”µï¼‰ï¼Œçª—å£æ˜¯30å¤©ï¼Œè¾“å‡ºæ—¥æœŸã€å¼€ç›˜ã€æ”¶ç›˜ã€æœ€é«˜ã€æœ€ä½ã€æˆäº¤é‡ã€MACDå’ŒEMAã€‚
            </p>

            <div class="variable-example">
                å‘¨K__360å¤©_RSI
            </div>
            <p style="color: #606266; line-height: 1.6;">
                è¡¨ç¤ºï¼šä½¿ç”¨å‘¨Kçº¿ï¼Œå½“å‰é€‰ä¸­è‚¡ç¥¨ï¼Œçª—å£æ˜¯360å¤©ï¼Œè¾“å‡ºåŸºç¡€Kçº¿æ•°æ®å’ŒRSIæŒ‡æ ‡ã€‚
            </p>

            <div class="variable-example">
                1åˆ†é’ŸK
            </div>
            <p style="color: #606266; line-height: 1.6;">
                è¡¨ç¤ºï¼šä½¿ç”¨1åˆ†é’ŸKçº¿ï¼Œå½“å‰é€‰ä¸­è‚¡ç¥¨ï¼Œé»˜è®¤2å¤©çª—å£ï¼Œè¾“å‡ºåŸºç¡€Kçº¿æ•°æ®ã€‚
            </p>
            
            <h4 style="font-size: 1rem; color: #667eea; margin-top: 1rem;">ä»“ä½ä¿¡æ¯ç¤ºä¾‹</h4>
            <div class="variable-example">
                æŒä»“
            </div>
            <p style="color: #606266; line-height: 1.6;">
                è·å–æ‰€æœ‰æŒä»“è‚¡ç¥¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒä»“æ•°é‡ã€æˆæœ¬ä»·ã€å½“å‰ä»·ã€ç›ˆäºé‡‘é¢ã€ç›ˆäºæ¯”ä¾‹ï¼Œä»¥åŠæ€»å¸‚å€¼ã€æ€»æˆæœ¬ã€æ€»ç›ˆäºç­‰æ±‡æ€»æ•°æ®ã€‚
            </p>

            <div class="variable-example">
                å¯ç”¨èµ„é‡‘
            </div>
            <p style="color: #606266; line-height: 1.6;">
                è·å–å½“å‰è´¦æˆ·çš„å¯ç”¨ç°é‡‘ä½™é¢ã€‚
            </p>
            
            <h4 style="font-size: 1rem; color: #667eea; margin-top: 1rem;">ç»„åˆä½¿ç”¨ç¤ºä¾‹</h4>
            <div class="variable-example">
                æ ¹æ® æŒä»“ å’Œ å¯ç”¨èµ„é‡‘ çš„æƒ…å†µï¼Œç»“åˆ æ—¥K__30å¤©_MACD åˆ¤æ–­æ˜¯å¦é€‚åˆåŠ ä»“ã€‚
            </div>
            <p style="color: #606266; line-height: 1.6;">
                AIå°†è·å–å®Œæ•´çš„æŒä»“ä¿¡æ¯ã€å¯ç”¨èµ„é‡‘å’ŒKçº¿æ•°æ®ï¼Œç»¼åˆåˆ†æåç»™å‡ºåŠ ä»“å»ºè®®ã€‚
            </p>
        </div>
    </div>
</div>

<!-- æ¨¡ç‰ˆé€‰æ‹©æ¨¡æ€æ¡† -->
<div id="templateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“‹ é€‰æ‹©å¯¹è¯æ¨¡ç‰ˆ</h2>
            <span class="close" onclick="closeTemplateModal()">&times;</span>
        </div>
        <div id="templateList">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<script>
let currentStock = null;

// åŠ è½½è‡ªé€‰è‚¡
async function loadWatchlist() {
    try {
        const response = await fetch('/api/watchlist');
        const result = await response.json();
        
        if (result.success) {
            const container = document.getElementById('watchlistContainer');
            if (result.data.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— è‡ªé€‰è‚¡</div>';
            } else {
                container.innerHTML = result.data.map(stock => {
                    // æ£€æµ‹ä»£ç ç±»å‹
                    let typeLabel = 'Aè‚¡';
                    let typeClass = 'stock-type-stock';
                    const code = stock.stock_code.split('.')[0];
                    
                    if (code.startsWith('000') || code.startsWith('399')) {
                        typeLabel = 'æŒ‡æ•°';
                        typeClass = 'stock-type-index';
                    } else if (code.startsWith('51') || code.startsWith('52') || code.startsWith('15') || code.startsWith('16')) {
                        typeLabel = 'ETF';
                        typeClass = 'stock-type-fund';
                    }
                    
                    return `
                        <div class="stock-item" onclick="selectStock('${stock.stock_code}', '${stock.stock_name}')">
                            <div class="stock-code">
                                ${stock.stock_code}
                                <span class="stock-type-badge ${typeClass}">${typeLabel}</span>
                            </div>
                            <div class="stock-name">${stock.stock_name || ''}</div>
                        </div>
                    `;
                }).join('');
            }
        }
    } catch (error) {
        console.error('åŠ è½½è‡ªé€‰è‚¡å¤±è´¥:', error);
    }
}

// æ·»åŠ è‡ªé€‰è‚¡
async function addToWatchlist() {
    const input = document.getElementById('newStockCode');
    const stockCode = input.value.trim();
    
    if (!stockCode) {
        showMessage('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/watchlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock_code: stockCode })
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('æ·»åŠ æˆåŠŸ');
            input.value = '';
            loadWatchlist();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
    }
}

// é€‰æ‹©è‚¡ç¥¨
async function selectStock(stockCode, stockName) {
    currentStock = { code: stockCode, name: stockName };
    
    // æ›´æ–°UI
    document.querySelectorAll('.stock-item').forEach(item => item.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    document.getElementById('currentStockTitle').textContent = `${stockName} (${stockCode})`;
    document.getElementById('updateBtn').disabled = false;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('clearChatBtn').disabled = false;
    document.getElementById('helpBtn').disabled = false;
    
    // åŠ è½½Kçº¿æ•°æ®å’ŒèŠå¤©è®°å½•
    await loadKlineCharts();
    await loadChatHistory();
}

// åŠ è½½Kçº¿å›¾æ•°æ®
async function loadKlineCharts() {
    if (!currentStock) return;
    
    try {
        // å¹¶è¡ŒåŠ è½½ä¸‰ç§å‘¨æœŸçš„æ•°æ®
        const [minuteRes, dailyRes, weeklyRes] = await Promise.all([
            fetch(`/api/stock/data/${currentStock.code}?period=minute&days=1440`),
            fetch(`/api/stock/data/${currentStock.code}?period=daily&days=60`),
            fetch(`/api/stock/data/${currentStock.code}?period=weekly&days=52`)
        ]);
        
        // æ£€æŸ¥HTTPçŠ¶æ€ç 
        if (!minuteRes.ok || !dailyRes.ok || !weeklyRes.ok) {
            throw new Error(`HTTPé”™è¯¯: minute=${minuteRes.status}, daily=${dailyRes.status}, weekly=${weeklyRes.status}`);
        }
        
        const minuteResult = await minuteRes.json();
        const dailyResult = await dailyRes.json();
        const weeklyResult = await weeklyRes.json();
        
        // æ‰“å°è¯¦ç»†æ—¥å¿—
        console.log('1åˆ†é’ŸKçº¿æ•°æ®:', minuteResult);
        console.log('æ—¥Kçº¿æ•°æ®:', dailyResult);
        console.log('å‘¨Kçº¿æ•°æ®:', weeklyResult);
        
        // æ¸²æŸ“å›¾è¡¨
        if (minuteResult.success && minuteResult.data && minuteResult.data.length > 0) {
            renderKlineChart('minuteChart', minuteResult.data, '1åˆ†é’ŸKçº¿');
        } else {
            console.warn('1åˆ†é’ŸKçº¿æ— æ•°æ®æˆ–å¤±è´¥:', minuteResult);
            document.getElementById('minuteChart').innerHTML = '<div class="chart-placeholder">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»"æ›´æ–°æ•°æ®"</div>';
        }
        
        if (dailyResult.success && dailyResult.data && dailyResult.data.length > 0) {
            renderKlineChart('dailyChart', dailyResult.data, 'æ—¥Kçº¿');
        } else {
            console.warn('æ—¥Kçº¿æ— æ•°æ®æˆ–å¤±è´¥:', dailyResult);
            document.getElementById('dailyChart').innerHTML = '<div class="chart-placeholder">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»"æ›´æ–°æ•°æ®"</div>';
        }
        
        if (weeklyResult.success && weeklyResult.data && weeklyResult.data.length > 0) {
            renderKlineChart('weeklyChart', weeklyResult.data, 'å‘¨Kçº¿');
        } else {
            console.warn('å‘¨Kçº¿æ— æ•°æ®æˆ–å¤±è´¥:', weeklyResult);
            document.getElementById('weeklyChart').innerHTML = '<div class="chart-placeholder">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»"æ›´æ–°æ•°æ®"</div>';
        }
    } catch (error) {
        console.error('åŠ è½½Kçº¿æ•°æ®å¤±è´¥:', error);
        // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        showMessage('åŠ è½½Kçº¿æ•°æ®å¤±è´¥: ' + error.message, 'error');
    }
}

// æ¸²æŸ“Kçº¿å›¾
function renderKlineChart(containerId, data, title) {
    // æ£€æŸ¥EChartsæ˜¯å¦å¯ç”¨
    if (typeof echarts === 'undefined') {
        console.error('EChartsæœªå®šä¹‰ï¼Œæ— æ³•æ¸²æŸ“å›¾è¡¨');
        document.getElementById(containerId).innerHTML = 
            '<div class="chart-placeholder" style="color: #f56c6c;">å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
        return;
    }
    
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`å®¹å™¨ ${containerId} ä¸å­˜åœ¨`);
        return;
    }
    
    try {
        const chart = echarts.init(container);
        
        // å‡†å¤‡æ•°æ®
        const dates = data.map(d => {
            if (d.trade_time) {
                // åˆ†é’Ÿæ•°æ®
                const dt = new Date(d.trade_time);
                return `${dt.getMonth()+1}/${dt.getDate()} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
            } else {
                // æ—¥K/å‘¨Kæ•°æ®
                return formatDate(d.trade_date);
            }
        });
        
        const ohlc = data.map(d => [d.open, d.close, d.low, d.high]);
        const volumes = data.map(d => d.volume || 0);
    
    // é…ç½®é¡¹
    const option = {
        animation: false,
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            },
            formatter: function(params) {
                let result = params[0].name + '<br/>';
                const candleData = params[0].data;
                result += 'å¼€ç›˜: ' + candleData[1].toFixed(2) + '<br/>';
                result += 'æ”¶ç›˜: ' + candleData[2].toFixed(2) + '<br/>';
                result += 'æœ€ä½: ' + candleData[3].toFixed(2) + '<br/>';
                result += 'æœ€é«˜: ' + candleData[4].toFixed(2) + '<br/>';
                if (params[1]) {
                    result += 'æˆäº¤é‡: ' + (params[1].data / 10000).toFixed(2) + 'ä¸‡';
                }
                return result;
            }
        },
        grid: [
            {
                left: '5%',
                right: '5%',
                top: '10%',
                height: '60%'
            },
            {
                left: '5%',
                right: '5%',
                top: '75%',
                height: '15%'
            }
        ],
        xAxis: [
            {
                type: 'category',
                data: dates,
                scale: true,
                boundaryGap: false,
                axisLine: { onZero: false },
                splitLine: { show: false },
                splitNumber: 20,
                axisLabel: {
                    rotate: 45,
                    interval: Math.floor(dates.length / 10)
                }
            },
            {
                type: 'category',
                gridIndex: 1,
                data: dates,
                scale: true,
                boundaryGap: false,
                axisLine: { onZero: false },
                axisTick: { show: false },
                splitLine: { show: false },
                axisLabel: { show: false }
            }
        ],
        yAxis: [
            {
                scale: true,
                splitArea: {
                    show: true
                }
            },
            {
                scale: true,
                gridIndex: 1,
                splitNumber: 2,
                axisLabel: { show: false },
                axisLine: { show: false },
                axisTick: { show: false },
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            {
                type: 'inside',
                xAxisIndex: [0, 1],
                start: 0,
                end: 100
            },
            {
                show: true,
                xAxisIndex: [0, 1],
                type: 'slider',
                top: '90%',
                start: 0,
                end: 100
            }
        ],
        series: [
            {
                name: title,
                type: 'candlestick',
                data: ohlc,
                itemStyle: {
                    color: '#ef5350',
                    color0: '#26a69a',
                    borderColor: '#ef5350',
                    borderColor0: '#26a69a'
                }
            },
            {
                name: 'æˆäº¤é‡',
                type: 'bar',
                xAxisIndex: 1,
                yAxisIndex: 1,
                data: volumes,
                itemStyle: {
                    color: function(params) {
                        const index = params.dataIndex;
                        const candleData = ohlc[index];
                        return candleData[1] > candleData[2] ? '#26a69a' : '#ef5350';
                    }
                }
            }
        ]
    };
    
    chart.setOption(option);
    
    // å“åº”å¼è°ƒæ•´
    window.addEventListener('resize', () => {
        chart.resize();
    });
    
    // æ”¯æŒé”®ç›˜ç¼©æ”¾
    container.tabIndex = 0;  // ä½¿divå¯èšç„¦
    container.addEventListener('keydown', (e) => {
        const currentZoom = chart.getOption().dataZoom[0];
        const range = currentZoom.end - currentZoom.start;
        
        if (e.key === 'ArrowUp') {
            // æ”¾å¤§ï¼ˆç¼©å°èŒƒå›´ï¼‰
            e.preventDefault();
            const newRange = Math.max(range * 0.8, 5);
            const center = (currentZoom.start + currentZoom.end) / 2;
            chart.dispatchAction({
                type: 'dataZoom',
                start: Math.max(center - newRange / 2, 0),
                end: Math.min(center + newRange / 2, 100)
            });
        } else if (e.key === 'ArrowDown') {
            // ç¼©å°ï¼ˆæ‰©å¤§èŒƒå›´ï¼‰
            e.preventDefault();
            const newRange = Math.min(range * 1.25, 100);
            const center = (currentZoom.start + currentZoom.end) / 2;
            chart.dispatchAction({
                type: 'dataZoom',
                start: Math.max(center - newRange / 2, 0),
                end: Math.min(center + newRange / 2, 100)
            });
        }
    });
    } catch (error) {
        console.error('æ¸²æŸ“Kçº¿å›¾å¤±è´¥:', error);
        document.getElementById(containerId).innerHTML = 
            '<div class="chart-placeholder" style="color: #f56c6c;">å›¾è¡¨æ¸²æŸ“å¤±è´¥: ' + error.message + '</div>';
    }
}


// æ›´æ–°è‚¡ç¥¨æ•°æ®
async function updateStockData() {
    if (!currentStock) return;
    
    const btn = document.getElementById('updateBtn');
    btn.disabled = true;
    btn.textContent = 'æ›´æ–°ä¸­...';
    
    try {
        const response = await fetch(`/api/stock/update/${currentStock.code}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('æ•°æ®æ›´æ–°æˆåŠŸ');
            await loadKlineCharts();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'æ›´æ–°æ•°æ®';
    }
}


// åŠ è½½èŠå¤©è®°å½• - å°†ç”¨æˆ·é—®é¢˜å’ŒAIå›å¤ç»„åˆåœ¨ä¸€èµ·
async function loadChatHistory() {
    if (!currentStock) return;
    
    try {
        const response = await fetch(`/api/chat/history/${currentStock.code}`);
        const result = await response.json();
        
        const container = document.getElementById('chatHistory');
        if (result.success && result.data.length > 0) {
            // æŒ‰å¯¹è¯ç»„ç»‡æ¶ˆæ¯ï¼šæ¯ä¸ªç”¨æˆ·æ¶ˆæ¯åè·ŸéšAIå›å¤
            const messages = result.data;
            let html = '';
            
            // æŒ‰æ—¶é—´åˆ†ç»„å¯¹è¯
            let i = 0;
            while (i < messages.length) {
                const msg = messages[i];
                
                if (msg.role === 'user') {
                    // å¼€å§‹ä¸€ä¸ªæ–°çš„å¯¹è¯ç»„ - ç”¨æˆ·é—®é¢˜åœ¨ä¸Š
                    html += '<div class="chat-group">';
                    html += `
                        <div class="chat-message user">
                            <div>${escapeHtml(msg.content)}</div>
                            <div class="chat-time">${formatDateTime(msg.created_at)}</div>
                        </div>
                    `;
                    
                    // æŸ¥æ‰¾ç´§éšå…¶åçš„AIå›å¤
                    if (i + 1 < messages.length && messages[i + 1].role === 'assistant') {
                        const aiMsg = messages[i + 1];
                        html += `
                            <div class="chat-message assistant">
                                ${renderMarkdown(aiMsg.content)}
                                <div class="chat-time">${formatDateTime(aiMsg.created_at)}</div>
                            </div>
                        `;
                        i++; // è·³è¿‡å·²å¤„ç†çš„AIæ¶ˆæ¯
                    }
                    
                    html += '</div>'; // ç»“æŸå¯¹è¯ç»„
                } else if (msg.role === 'assistant') {
                    // å•ç‹¬çš„AIæ¶ˆæ¯ï¼ˆå¦‚AIåˆ†æï¼‰ï¼Œæ²¡æœ‰é…å¯¹çš„ç”¨æˆ·é—®é¢˜
                    html += `
                        <div class="chat-group">
                            <div class="chat-message assistant">
                                ${renderMarkdown(msg.content)}
                                <div class="chat-time">${formatDateTime(msg.created_at)}</div>
                            </div>
                        </div>
                    `;
                }
                
                i++;
            }
            
            container.innerHTML = html;
            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        } else {
            // å¯¹è¯ä¸ºç©ºï¼Œæ˜¾ç¤ºæ¨¡ç‰ˆé€‰æ‹©æŒ‰é’®
            container.innerHTML = `
                <div class="empty-state">
                    <p style="margin-bottom: 1rem;">æš‚æ— å¯¹è¯è®°å½•</p>
                    <button class="btn btn-primary" onclick="showTemplateSelector()" id="selectTemplateBtn">é€‰æ‹©å¯¹è¯æ¨¡ç‰ˆ</button>
                </div>
            `;
        }
    } catch (error) {
        console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
    }
}

// HTMLè½¬ä¹‰å‡½æ•°ï¼ˆç”¨äºç”¨æˆ·è¾“å…¥ï¼‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ - 2026/2/18 16:46:12
function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
}

// æ¸²æŸ“Markdownå†…å®¹
function renderMarkdown(content) {
    if (!content) return '';
    
    // æ£€æŸ¥markedæ˜¯å¦åŠ è½½æˆåŠŸ
    if (typeof marked === 'undefined') {
        console.warn('âš ï¸ marked.js æœªåŠ è½½ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º');
        // ä½¿ç”¨çº¯æ–‡æœ¬ï¼Œä½†ä¿ç•™æ¢è¡Œ
        const escaped = escapeHtml(content);
        const withBreaks = escaped.replace(/\n/g, '<br>');
        return `<div class="markdown-content"><p>${withBreaks}</p></div>`;
    }
    
    try {
        // é…ç½®markedé€‰é¡¹
        marked.setOptions({
            breaks: true,        // æ”¯æŒæ¢è¡Œ
            gfm: true,          // æ”¯æŒGitHubé£æ ¼çš„Markdown
            headerIds: false,   // ä¸ç”Ÿæˆheader id
            mangle: false       // ä¸æ··æ·†é‚®ç®±åœ°å€
        });
        
        // æ¸²æŸ“Markdown
        const html = marked.parse(content);
        
        // åŒ…è£¹åœ¨markdown-contentç±»ä¸­
        return `<div class="markdown-content">${html}</div>`;
    } catch (error) {
        console.error('âŒ Markdownæ¸²æŸ“å¤±è´¥:', error);
        // é™çº§åˆ°çº¯æ–‡æœ¬
        const escaped = escapeHtml(content);
        const withBreaks = escaped.replace(/\n/g, '<br>');
        return `<div class="markdown-content"><p>${withBreaks}</p></div>`;
    }
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    if (!currentStock) return;
    
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) {
        showMessage('è¯·è¾“å…¥æ¶ˆæ¯', 'error');
        return;
    }
    
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    btn.textContent = 'å‘é€ä¸­...';
    
    // ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    const container = document.getElementById('chatHistory');
    const userMsgHtml = `
        <div class="chat-group" id="temp-msg">
            <div class="chat-message user">
                <div>${escapeHtml(message)}</div>
                <div class="chat-time">${formatDateTime(new Date())}</div>
            </div>
            <div class="chat-message assistant">
                <div class="markdown-content"><p><em>AIæ­£åœ¨æ€è€ƒä¸­...</em></p></div>
            </div>
        </div>
    `;
    
    // å¦‚æœæœ‰ç©ºçŠ¶æ€æç¤ºï¼Œå…ˆæ¸…é™¤
    if (container.querySelector('.empty-state')) {
        container.innerHTML = '';
    }
    
    container.insertAdjacentHTML('beforeend', userMsgHtml);
    container.scrollTop = container.scrollHeight;
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    try {
        console.log('ğŸ“¨ å‘é€æ¶ˆæ¯åˆ°API...');
        const response = await fetch('/api/chat/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stock_code: currentStock.code,
                message: message
            })
        });
        
        console.log('ğŸ“¥ æ”¶åˆ°APIå“åº”, status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('âœ… APIç»“æœ:', result);
        
        if (result.success) {
            // åˆ é™¤ä¸´æ—¶æ¶ˆæ¯
            document.getElementById('temp-msg')?.remove();
            console.log('ğŸ”„ é‡æ–°åŠ è½½èŠå¤©è®°å½•...');
            // é‡æ–°åŠ è½½å®Œæ•´çš„èŠå¤©è®°å½•ï¼ˆåŒ…å«çœŸå®çš„AIå›å¤ï¼‰
            await loadChatHistory();
            console.log('âœ… èŠå¤©è®°å½•åŠ è½½å®Œæˆ');
        } else {
            // åˆ é™¤ä¸´æ—¶æ¶ˆæ¯å¹¶æ˜¾ç¤ºé”™è¯¯
            document.getElementById('temp-msg')?.remove();
            showMessage(result.message, 'error');
        }
    } catch (error) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        // åˆ é™¤ä¸´æ—¶æ¶ˆæ¯å¹¶æ˜¾ç¤ºé”™è¯¯
        document.getElementById('temp-msg')?.remove();
        showMessage('å‘é€å¤±è´¥: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'å‘é€';
    }
}

// æ¸…é™¤èŠå¤©è®°å½•
async function clearChat() {
    if (!currentStock) return;
    
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/api/chat/clear/${currentStock.code}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('èŠå¤©è®°å½•å·²æ¸…é™¤');
            await loadChatHistory();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// æ˜¾ç¤ºå˜é‡å¸®åŠ©å¼¹çª—
function showVariablesHelp() {
    document.getElementById('variablesModal').style.display = 'block';
}

// å…³é—­å˜é‡å¸®åŠ©å¼¹çª—
function closeVariablesModal() {
    document.getElementById('variablesModal').style.display = 'none';
}

// æ˜¾ç¤ºæ¨¡ç‰ˆé€‰æ‹©å™¨
async function showTemplateSelector() {
    const modal = document.getElementById('templateModal');
    modal.style.display = 'block';
    
    // åŠ è½½æ¨¡ç‰ˆåˆ—è¡¨
    try {
        const response = await fetch('/api/templates');
        const result = await response.json();
        
        const container = document.getElementById('templateList');
        if (result.success && result.data.length > 0) {
            container.innerHTML = result.data.map(tpl => `
                <div class="template-item" onclick="selectTemplate(${tpl.id})">
                    <div class="template-name">${escapeHtml(tpl.name)}</div>
                    <div class="template-content">${escapeHtml(tpl.content)}</div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="empty-state">æš‚æ— æ¨¡ç‰ˆï¼Œè¯·å…ˆåœ¨"å¯¹è¯æ¨¡ç‰ˆ"é¡µé¢åˆ›å»º</div>';
        }
    } catch (error) {
        showMessage('åŠ è½½æ¨¡ç‰ˆå¤±è´¥: ' + error.message, 'error');
    }
}

// å…³é—­æ¨¡ç‰ˆé€‰æ‹©å¼¹çª—
function closeTemplateModal() {
    document.getElementById('templateModal').style.display = 'none';
}

// é€‰æ‹©æ¨¡ç‰ˆå¹¶å¡«å……
async function selectTemplate(templateId) {
    try {
        const response = await fetch('/api/templates');
        const result = await response.json();
        
        if (result.success) {
            const template = result.data.find(t => t.id === templateId);
            if (template) {
                document.getElementById('chatInput').value = template.content;
                closeTemplateModal();
                showMessage('æ¨¡ç‰ˆå·²å¡«å……åˆ°è¾“å…¥æ¡†');
            }
        }
    } catch (error) {
        showMessage('åŠ è½½æ¨¡ç‰ˆå¤±è´¥: ' + error.message, 'error');
    }
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    const variablesModal = document.getElementById('variablesModal');
    const templateModal = document.getElementById('templateModal');
    
    if (event.target === variablesModal) {
        closeVariablesModal();
    }
    if (event.target === templateModal) {
        closeTemplateModal();
    }
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', () => {
    // æ£€æŸ¥EChartsæ˜¯å¦åŠ è½½
    if (typeof echarts === 'undefined') {
        showMessage('å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        console.error('EChartsæœªå®šä¹‰ï¼Œå¯èƒ½CDNåŠ è½½å¤±è´¥');
        return;
    }
    
    loadWatchlist();
    
    // å›è½¦æ¢è¡Œï¼ŒShift+å›è½¦å‘é€æ¶ˆæ¯
    const chatInput = document.getElementById('chatInput');
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.shiftKey) {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            sendMessage();
        }
        // å•ç‹¬æŒ‰å›è½¦ä¼šä¿æŒé»˜è®¤è¡Œä¸ºï¼ˆæ¢è¡Œï¼‰
    });
});
</script>
{% endblock %}
