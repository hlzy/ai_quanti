{% extends "base.html" %}

{% block title %}æŒä»“ç®¡ç† - AIé‡åŒ–å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .summary-card.green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .summary-card.red {
        background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    }

    .summary-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }

    .summary-value {
        font-size: 2rem;
        font-weight: 600;
    }

    .positions-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
    }

    .positions-table th,
    .positions-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
    }

    .positions-table th {
        background: #f5f7fa;
        font-weight: 600;
        color: #606266;
    }

    .positions-table tr:hover {
        background: #f8f9fa;
    }

    .profit-positive {
        color: #67c23a;
        font-weight: 600;
    }

    .profit-negative {
        color: #f56c6c;
        font-weight: 600;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    .modal-footer {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
    }

    .btn-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .empty-table {
        text-align: center;
        padding: 3rem;
        color: #909399;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="summary-cards" id="summaryCards">
    <div class="summary-card">
        <div class="summary-label">ğŸ’° ç°é‡‘ä½™é¢</div>
        <div class="summary-value" id="cashBalance">-</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">ğŸ“Š æŒä»“å¸‚å€¼</div>
        <div class="summary-value" id="marketValue">-</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">ğŸ’¼ æ€»èµ„äº§</div>
        <div class="summary-value" id="totalAssets">-</div>
    </div>
    <div class="summary-card" id="profitCard">
        <div class="summary-label">ğŸ“ˆ æ€»ç›ˆäº</div>
        <div class="summary-value" id="totalProfit">-</div>
    </div>
</div>

<div class="card">
    <div class="card-header">æŒä»“åˆ—è¡¨</div>
    
    <div class="btn-group">
        <button class="btn btn-primary" onclick="showAddPositionModal()">â• æ·»åŠ æŒä»“</button>
        <button class="btn btn-primary" onclick="showUpdateCashModal()">ğŸ’° è®¾ç½®ç°é‡‘</button>
        <button class="btn btn-success" onclick="updateAllPrices()">ğŸ”„ æ›´æ–°ä»·æ ¼</button>
    </div>

    <div id="positionsTableContainer">
        <div class="loading">åŠ è½½ä¸­</div>
    </div>
</div>

<!-- æ·»åŠ æŒä»“å¼¹çª— -->
<div class="modal" id="addPositionModal">
    <div class="modal-content">
        <div class="modal-header">æ·»åŠ /æ›´æ–°æŒä»“</div>
        <form id="positionForm">
            <div class="input-group">
                <label>è‚¡ç¥¨ä»£ç  *</label>
                <input type="text" id="stockCode" required placeholder="ä¾‹å¦‚: 688800.SH" onblur="fetchStockName()" />
            </div>
            <div class="input-group">
                <label>è‚¡ç¥¨åç§°</label>
                <input type="text" id="stockName" placeholder="è‡ªåŠ¨è·å–æˆ–æ‰‹åŠ¨è¾“å…¥" />
                <small style="color: #999; font-size: 0.85rem;">è¾“å…¥è‚¡ç¥¨ä»£ç åè‡ªåŠ¨è·å–ï¼Œä¹Ÿå¯æ‰‹åŠ¨ä¿®æ”¹</small>
            </div>
            <div class="input-group">
                <label>æŒä»“æ•°é‡ *</label>
                <input type="number" id="quantity" required min="1" placeholder="è‚¡æ•°" />
            </div>
            <div class="input-group">
                <label>æˆæœ¬ä»· *</label>
                <input type="number" id="costPrice" required min="0" step="0.01" placeholder="å…ƒ" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('addPositionModal')">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¡®å®š</button>
            </div>
        </form>
    </div>
</div>

<!-- è®¾ç½®ç°é‡‘å¼¹çª— -->
<div class="modal" id="updateCashModal">
    <div class="modal-content">
        <div class="modal-header">è®¾ç½®ç°é‡‘ä½™é¢</div>
        <form id="cashForm">
            <div class="input-group">
                <label>ç°é‡‘ä½™é¢ *</label>
                <input type="number" id="cashInput" required min="0" step="0.01" placeholder="å…ƒ" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('updateCashModal')">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¡®å®š</button>
            </div>
        </form>
    </div>
</div>

<script>
// åŠ è½½æŠ•èµ„ç»„åˆæ•°æ®
async function loadPortfolio() {
    try {
        const response = await fetch('/api/positions');
        const result = await response.json();
        
        if (result.success) {
            updateSummary(result.data);
            displayPositions(result.data.positions);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    }
}

// æ›´æ–°æ±‡æ€»ä¿¡æ¯
function updateSummary(data) {
    document.getElementById('cashBalance').textContent = 'Â¥' + formatNumber(data.cash);
    document.getElementById('marketValue').textContent = 'Â¥' + formatNumber(data.total_market_value);
    document.getElementById('totalAssets').textContent = 'Â¥' + formatNumber(data.total_assets);
    
    const profitValue = data.total_profit_loss;
    const profitCard = document.getElementById('profitCard');
    
    if (profitValue > 0) {
        profitCard.className = 'summary-card green';
        document.getElementById('totalProfit').textContent = '+Â¥' + formatNumber(profitValue);
    } else if (profitValue < 0) {
        profitCard.className = 'summary-card red';
        document.getElementById('totalProfit').textContent = 'Â¥' + formatNumber(profitValue);
    } else {
        profitCard.className = 'summary-card';
        document.getElementById('totalProfit').textContent = 'Â¥0.00';
    }
}

// æ˜¾ç¤ºæŒä»“åˆ—è¡¨
function displayPositions(positions) {
    const container = document.getElementById('positionsTableContainer');
    
    if (positions.length === 0) {
        container.innerHTML = '<div class="empty-table">æš‚æ— æŒä»“æ•°æ®<br>ç‚¹å‡»"æ·»åŠ æŒä»“"å¼€å§‹è®°å½•</div>';
        return;
    }
    
    container.innerHTML = `
        <table class="positions-table">
            <thead>
                <tr>
                    <th>è‚¡ç¥¨ä»£ç </th>
                    <th>è‚¡ç¥¨åç§°</th>
                    <th>æŒä»“æ•°é‡</th>
                    <th>æˆæœ¬ä»·</th>
                    <th>å½“å‰ä»·</th>
                    <th>å¸‚å€¼</th>
                    <th>ç›ˆäºé‡‘é¢</th>
                    <th>ç›ˆäºæ¯”ä¾‹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                ${positions.map(pos => {
                    const currentPrice = pos.current_price || pos.cost_price;
                    const marketValue = currentPrice * pos.quantity;
                    const profitClass = pos.profit_loss > 0 ? 'profit-positive' : pos.profit_loss < 0 ? 'profit-negative' : '';
                    const profitSign = pos.profit_loss > 0 ? '+' : '';
                    return `
                        <tr>
                            <td>${pos.stock_code}</td>
                            <td>${pos.stock_name || '-'}</td>
                            <td>${pos.quantity}</td>
                            <td>Â¥${formatNumber(pos.cost_price)}</td>
                            <td>Â¥${formatNumber(currentPrice)}</td>
                            <td>Â¥${formatNumber(marketValue)}</td>
                            <td class="${profitClass}">${pos.profit_loss ? profitSign + 'Â¥' + formatNumber(pos.profit_loss) : '-'}</td>
                            <td class="${profitClass}">${pos.profit_loss_pct ? profitSign + formatNumber(pos.profit_loss_pct) + '%' : '-'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="updateSinglePrice('${pos.stock_code}')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">æ›´æ–°</button>
                                    <button class="btn btn-danger" onclick="deletePosition('${pos.stock_code}')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">åˆ é™¤</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

// æ˜¾ç¤ºæ·»åŠ æŒä»“å¼¹çª—
function showAddPositionModal() {
    document.getElementById('positionForm').reset();
    document.getElementById('addPositionModal').classList.add('active');
}

// æ˜¾ç¤ºè®¾ç½®ç°é‡‘å¼¹çª—
async function showUpdateCashModal() {
    try {
        const response = await fetch('/api/cash');
        const result = await response.json();
        if (result.success) {
            document.getElementById('cashInput').value = result.data.balance;
        }
    } catch (error) {
        console.error('è·å–ç°é‡‘ä½™é¢å¤±è´¥:', error);
    }
    document.getElementById('updateCashModal').classList.add('active');
}

// å…³é—­å¼¹çª—
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// æ·»åŠ æŒä»“è¡¨å•æäº¤
document.getElementById('positionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        stock_code: document.getElementById('stockCode').value.trim(),
        stock_name: document.getElementById('stockName').value.trim() || null,
        quantity: parseInt(document.getElementById('quantity').value),
        cost_price: parseFloat(document.getElementById('costPrice').value)
    };
    
    try {
        const response = await fetch('/api/positions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('æ“ä½œæˆåŠŸï¼Œå·²è‡ªåŠ¨åŠ å…¥è‡ªé€‰è‚¡');
            closeModal('addPositionModal');
            loadPortfolio();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error');
    }
});

// è‡ªåŠ¨è·å–è‚¡ç¥¨åç§°
async function fetchStockName() {
    const stockCode = document.getElementById('stockCode').value.trim();
    if (!stockCode) return;
    
    try {
        const response = await fetch(`/api/stock/info/${stockCode}`);
        const result = await response.json();
        
        if (result.success && result.data) {
            document.getElementById('stockName').value = result.data.name;
        }
    } catch (error) {
        console.error('è·å–è‚¡ç¥¨åç§°å¤±è´¥:', error);
    }
}

// è®¾ç½®ç°é‡‘è¡¨å•æäº¤
document.getElementById('cashForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const balance = parseFloat(document.getElementById('cashInput').value);
    
    try {
        const response = await fetch('/api/cash', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ balance })
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('ç°é‡‘ä½™é¢æ›´æ–°æˆåŠŸ');
            closeModal('updateCashModal');
            loadPortfolio();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
    }
});

// åˆ é™¤æŒä»“
async function deletePosition(stockCode) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${stockCode} çš„æŒä»“å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch(`/api/positions/${stockCode}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('åˆ é™¤æˆåŠŸ');
            loadPortfolio();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// æ›´æ–°æ‰€æœ‰æŒä»“ä»·æ ¼
async function updateAllPrices() {
    try {
        showMessage('æ­£åœ¨æ›´æ–°ä»·æ ¼...', 'success');
        const response = await fetch('/api/positions/update-prices', {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('ä»·æ ¼æ›´æ–°æˆåŠŸ');
            loadPortfolio();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
    }
}

// æ›´æ–°å•ä¸ªæŒä»“ä»·æ ¼
async function updateSinglePrice(stockCode) {
    try {
        // å…ˆæ›´æ–°è‚¡ç¥¨æ•°æ®
        const updateResponse = await fetch(`/api/stock/update/${stockCode}`, {
            method: 'POST'
        });
        const updateResult = await updateResponse.json();
        
        if (!updateResult.success) {
            showMessage('æ•°æ®æ›´æ–°å¤±è´¥: ' + updateResult.message, 'error');
            return;
        }
        
        // è·å–æœ€æ–°ä»·æ ¼å¹¶æ›´æ–°æŒä»“
        const dataResponse = await fetch(`/api/stock/data/${stockCode}?period=daily&days=1`);
        const dataResult = await dataResponse.json();
        
        if (dataResult.success && dataResult.data && dataResult.data.length > 0) {
            const latestPrice = dataResult.data[0].close;
            
            // æ›´æ–°æŒä»“ä»·æ ¼ï¼ˆé€šè¿‡é‡æ–°åŠ è½½å®ç°ï¼‰
            showMessage('ä»·æ ¼æ›´æ–°æˆåŠŸ');
            loadPortfolio();
        } else {
            showMessage('è·å–æœ€æ–°ä»·æ ¼å¤±è´¥', 'error');
        }
    } catch (error) {
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
    }
}

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', () => {
    loadPortfolio();
});
</script>
{% endblock %}
