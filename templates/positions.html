{% extends "base.html" %}

{% block title %}æŒä»“ç®¡ç† - AIé‡åŒ–å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .summary-card.green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .summary-card.red {
        background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    }

    .summary-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }

    .summary-value {
        font-size: 2rem;
        font-weight: 600;
    }

    .positions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(900px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .position-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }

    .position-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .position-title {
        font-size: 1.3rem;
        font-weight: 600;
    }

    .position-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .info-item {
        padding: 0.75rem;
        background: #f5f7fa;
        border-radius: 8px;
    }

    .info-label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.25rem;
    }

    .info-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
    }

    .profit-positive {
        color: #67c23a !important;
    }

    .profit-negative {
        color: #f56c6c !important;
    }

    .kline-container {
        margin-top: 1rem;
    }

    .kline-controls {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .kline-controls button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .kline-controls button.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .kline-controls button:hover {
        border-color: #667eea;
    }

    .chart-box {
        width: 100%;
        height: 300px;
        border: 1px solid #e4e7ed;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    .modal-footer {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
    }

    .btn-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #909399;
    }
</style>
{% endblock %}

{% block content %}
<div class="summary-cards" id="summaryCards">
    <div class="summary-card">
        <div class="summary-label">ğŸ’° ç°é‡‘ä½™é¢</div>
        <div class="summary-value" id="cashBalance">-</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">ğŸ“Š æŒä»“å¸‚å€¼</div>
        <div class="summary-value" id="marketValue">-</div>
    </div>
    <div class="summary-card">
        <div class="summary-label">ğŸ’¼ æ€»èµ„äº§</div>
        <div class="summary-value" id="totalAssets">-</div>
    </div>
    <div class="summary-card" id="profitCard">
        <div class="summary-label">ğŸ“ˆ æ€»ç›ˆäº</div>
        <div class="summary-value" id="totalProfit">-</div>
    </div>
</div>

<div class="card">
    <div class="card-header">æŒä»“åˆ—è¡¨</div>
    
    <div class="btn-group">
        <button class="btn btn-primary" onclick="showAddPositionModal()">â• æ·»åŠ æŒä»“</button>
        <button class="btn btn-primary" onclick="showUpdateCashModal()">ğŸ’° è®¾ç½®ç°é‡‘</button>
        <button class="btn btn-success" onclick="updateAllPrices()">ğŸ”„ æ›´æ–°ä»·æ ¼</button>
    </div>

    <div id="positionsContainer">
        <div class="loading">åŠ è½½ä¸­</div>
    </div>
</div>

<!-- æ·»åŠ æŒä»“å¼¹çª— -->
<div class="modal" id="addPositionModal">
    <div class="modal-content">
        <div class="modal-header">æ·»åŠ /æ›´æ–°æŒä»“</div>
        <form id="positionForm">
            <div class="input-group">
                <label>è‚¡ç¥¨ä»£ç  *</label>
                <input type="text" id="stockCode" required placeholder="ä¾‹å¦‚: 000001.SZ" />
            </div>
            <div class="input-group">
                <label>è‚¡ç¥¨åç§° *</label>
                <input type="text" id="stockName" required placeholder="ä¾‹å¦‚: å¹³å®‰é“¶è¡Œ" />
            </div>
            <div class="input-group">
                <label>æŒä»“æ•°é‡ *</label>
                <input type="number" id="quantity" required min="1" placeholder="è‚¡æ•°" />
            </div>
            <div class="input-group">
                <label>æˆæœ¬ä»· *</label>
                <input type="number" id="costPrice" required min="0" step="0.01" placeholder="å…ƒ" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('addPositionModal')">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¡®å®š</button>
            </div>
        </form>
    </div>
</div>

<!-- è®¾ç½®ç°é‡‘å¼¹çª— -->
<div class="modal" id="updateCashModal">
    <div class="modal-content">
        <div class="modal-header">è®¾ç½®ç°é‡‘ä½™é¢</div>
        <form id="cashForm">
            <div class="input-group">
                <label>ç°é‡‘ä½™é¢ *</label>
                <input type="number" id="cashInput" required min="0" step="0.01" placeholder="å…ƒ" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('updateCashModal')">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¡®å®š</button>
            </div>
        </form>
    </div>
</div>

<script>
// åŠ è½½æŠ•èµ„ç»„åˆæ•°æ®
async function loadPortfolio() {
    try {
        const response = await fetch('/api/positions');
        const result = await response.json();
        
        if (result.success) {
            updateSummary(result.data);
            displayPositions(result.data.positions);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    }
}

// æ›´æ–°æ±‡æ€»ä¿¡æ¯
function updateSummary(data) {
    document.getElementById('cashBalance').textContent = 'Â¥' + formatNumber(data.cash);
    document.getElementById('marketValue').textContent = 'Â¥' + formatNumber(data.total_market_value);
    document.getElementById('totalAssets').textContent = 'Â¥' + formatNumber(data.total_assets);
    
    const profitValue = data.total_profit_loss;
    const profitCard = document.getElementById('profitCard');
    
    if (profitValue > 0) {
        profitCard.className = 'summary-card green';
        document.getElementById('totalProfit').textContent = '+Â¥' + formatNumber(profitValue);
    } else if (profitValue < 0) {
        profitCard.className = 'summary-card red';
        document.getElementById('totalProfit').textContent = 'Â¥' + formatNumber(profitValue);
    } else {
        profitCard.className = 'summary-card';
        document.getElementById('totalProfit').textContent = 'Â¥0.00';
    }
}

// æ˜¾ç¤ºæŒä»“åˆ—è¡¨
function displayPositions(positions) {
    const container = document.getElementById('positionsContainer');
    
    if (positions.length === 0) {
        container.innerHTML = '<div class="empty-state">æš‚æ— æŒä»“æ•°æ®<br>ç‚¹å‡»"æ·»åŠ æŒä»“"å¼€å§‹è®°å½•</div>';
        return;
    }
    
    container.innerHTML = `
        <div class="positions-grid">
            ${positions.map(pos => {
                const profitClass = pos.profit_loss > 0 ? 'profit-positive' : pos.profit_loss < 0 ? 'profit-negative' : '';
                const profitSign = pos.profit_loss > 0 ? '+' : '';
                return `
                    <div class="position-card">
                        <div class="position-header">
                            <div class="position-title">${pos.stock_code} - ${pos.stock_name || '-'}</div>
                            <button class="btn btn-danger" onclick="deletePosition('${pos.stock_code}')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">åˆ é™¤</button>
                        </div>
                        
                        <div class="position-info">
                            <div class="info-item">
                                <div class="info-label">æŒä»“æ•°é‡</div>
                                <div class="info-value">${pos.quantity}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">æˆæœ¬ä»·</div>
                                <div class="info-value">Â¥${formatNumber(pos.cost_price)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å½“å‰ä»·</div>
                                <div class="info-value">Â¥${formatNumber(pos.current_price || pos.cost_price)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ç›ˆäºé‡‘é¢</div>
                                <div class="info-value ${profitClass}">${pos.profit_loss ? profitSign + 'Â¥' + formatNumber(pos.profit_loss) : '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ç›ˆäºæ¯”ä¾‹</div>
                                <div class="info-value ${profitClass}">${pos.profit_loss_pct ? profitSign + formatNumber(pos.profit_loss_pct) + '%' : '-'}</div>
                            </div>
                        </div>
                        
                        <div class="kline-container">
                            <div class="kline-controls">
                                <button class="active" onclick="switchPeriod('${pos.stock_code}', 'minute', this)">1åˆ†é’ŸK</button>
                                <button onclick="switchPeriod('${pos.stock_code}', 'daily', this)">æ—¥K</button>
                                <button onclick="switchPeriod('${pos.stock_code}', 'weekly', this)">å‘¨K</button>
                                <button onclick="updateStockData('${pos.stock_code}')" style="margin-left: auto;">ğŸ”„ æ›´æ–°æ•°æ®</button>
                            </div>
                            <div id="chart_${pos.stock_code}" class="chart-box"></div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    // åŠ è½½æ‰€æœ‰æŒä»“çš„Kçº¿å›¾
    positions.forEach(pos => {
        loadKlineChart(pos.stock_code, 'minute');
    });
}

// æ˜¾ç¤ºæ·»åŠ æŒä»“å¼¹çª—
function showAddPositionModal() {
    document.getElementById('positionForm').reset();
    document.getElementById('addPositionModal').classList.add('active');
}

// æ˜¾ç¤ºè®¾ç½®ç°é‡‘å¼¹çª—
async function showUpdateCashModal() {
    try {
        const response = await fetch('/api/cash');
        const result = await response.json();
        if (result.success) {
            document.getElementById('cashInput').value = result.data.balance;
        }
    } catch (error) {
        console.error('è·å–ç°é‡‘ä½™é¢å¤±è´¥:', error);
    }
    document.getElementById('updateCashModal').classList.add('active');
}

// å…³é—­å¼¹çª—
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// æ·»åŠ æŒä»“è¡¨å•æäº¤
document.getElementById('positionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        stock_code: document.getElementById('stockCode').value.trim(),
        stock_name: document.getElementById('stockName').value.trim(),
        quantity: parseInt(document.getElementById('quantity').value),
        cost_price: parseFloat(document.getElementById('costPrice').value)
    };
    
    try {
        const response = await fetch('/api/positions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('æ“ä½œæˆåŠŸ');
            closeModal('addPositionModal');
            loadPortfolio();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error');
    }
});

// è®¾ç½®ç°é‡‘è¡¨å•æäº¤
document.getElementById('cashForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const balance = parseFloat(document.getElementById('cashInput').value);
    
    try {
        const response = await fetch('/api/cash', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ balance })
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('ç°é‡‘ä½™é¢æ›´æ–°æˆåŠŸ');
            closeModal('updateCashModal');
            loadPortfolio();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
    }
});

// åˆ é™¤æŒä»“
async function deletePosition(stockCode) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${stockCode} çš„æŒä»“å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch(`/api/positions/${stockCode}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('åˆ é™¤æˆåŠŸ');
            loadPortfolio();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// æ›´æ–°æ‰€æœ‰æŒä»“ä»·æ ¼
async function updateAllPrices() {
    try {
        const response = await fetch('/api/positions/update-prices', {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            showMessage('ä»·æ ¼æ›´æ–°æˆåŠŸ');
            loadPortfolio();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
    }
}

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});

// Kçº¿å›¾ç›¸å…³åŠŸèƒ½
let chartInstances = {};

// åˆ‡æ¢å‘¨æœŸ
async function switchPeriod(stockCode, period, button) {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const container = button.parentElement;
    container.querySelectorAll('button').forEach(btn => {
        if (btn !== button && !btn.textContent.includes('æ›´æ–°')) {
            btn.classList.remove('active');
        }
    });
    button.classList.add('active');
    
    // åŠ è½½æ•°æ®
    await loadKlineChart(stockCode, period);
}

// åŠ è½½Kçº¿å›¾
async function loadKlineChart(stockCode, period = 'minute') {
    const chartId = `chart_${stockCode}`;
    const chartDom = document.getElementById(chartId);
    
    if (!chartDom) return;
    
    try {
        // è·å–å¤©æ•°
        let days = 2;
        if (period === 'daily') days = 60;
        if (period === 'weekly') days = 360;
        
        // è·å–æ•°æ®
        const response = await fetch(`/api/stock/data/${stockCode}?period=${period}&days=${days}`);
        const result = await response.json();
        
        if (!result.success || !result.data || result.data.length === 0) {
            chartDom.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">æš‚æ— æ•°æ®</div>';
            return;
        }
        
        renderKlineChart(chartId, result.data, stockCode, period);
    } catch (error) {
        console.error('åŠ è½½Kçº¿å›¾å¤±è´¥:', error);
        chartDom.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#f56c6c;">åŠ è½½å¤±è´¥</div>';
    }
}

// æ¸²æŸ“Kçº¿å›¾
function renderKlineChart(chartId, data, stockCode, period) {
    const chartDom = document.getElementById(chartId);
    if (!chartDom) return;
    
    // é”€æ¯æ—§å›¾è¡¨
    if (chartInstances[chartId]) {
        chartInstances[chartId].dispose();
    }
    
    // åˆ›å»ºæ–°å›¾è¡¨
    const chart = echarts.init(chartDom);
    chartInstances[chartId] = chart;
    
    // å‡†å¤‡æ•°æ®
    const dates = data.map(item => item.trade_date || item.trade_time);
    const values = data.map(item => [item.open, item.close, item.low, item.high]);
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            },
            formatter: function(params) {
                const item = data[params[0].dataIndex];
                return `
                    ${item.trade_date || item.trade_time}<br/>
                    å¼€: ${item.open}<br/>
                    æ”¶: ${item.close}<br/>
                    ä½: ${item.low}<br/>
                    é«˜: ${item.high}<br/>
                    é‡: ${(item.volume / 10000).toFixed(2)}ä¸‡
                `;
            }
        },
        grid: {
            left: '3%',
            right: '3%',
            bottom: '10%',
            top: '5%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates,
            axisLabel: {
                fontSize: 10,
                interval: Math.floor(dates.length / 8)
            }
        },
        yAxis: {
            type: 'value',
            scale: true,
            splitLine: {
                lineStyle: {
                    type: 'dashed'
                }
            }
        },
        dataZoom: [
            {
                type: 'inside',
                start: 0,
                end: 100
            }
        ],
        series: [
            {
                type: 'candlestick',
                data: values,
                itemStyle: {
                    color: '#ef5350',
                    color0: '#26a69a',
                    borderColor: '#ef5350',
                    borderColor0: '#26a69a'
                }
            }
        ]
    };
    
    chart.setOption(option);
    
    // é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            const currentOption = chart.getOption();
            const currentZoom = currentOption.dataZoom[0];
            const range = currentZoom.end - currentZoom.start;
            const newRange = Math.max(10, range * 0.8);
            const center = (currentZoom.start + currentZoom.end) / 2;
            chart.setOption({
                dataZoom: [{
                    start: Math.max(0, center - newRange / 2),
                    end: Math.min(100, center + newRange / 2)
                }]
            });
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            const currentOption = chart.getOption();
            const currentZoom = currentOption.dataZoom[0];
            const range = currentZoom.end - currentZoom.start;
            const newRange = Math.min(100, range * 1.2);
            const center = (currentZoom.start + currentZoom.end) / 2;
            chart.setOption({
                dataZoom: [{
                    start: Math.max(0, center - newRange / 2),
                    end: Math.min(100, center + newRange / 2)
                }]
            });
        }
    });
    
    // å“åº”å¼
    window.addEventListener('resize', () => chart.resize());
}

// æ›´æ–°è‚¡ç¥¨æ•°æ®
async function updateStockData(stockCode) {
    try {
        const response = await fetch(`/api/stock/update/${stockCode}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            showMessage('æ•°æ®æ›´æ–°æˆåŠŸ');
            // é‡æ–°åŠ è½½å½“å‰æ´»è·ƒçš„å›¾è¡¨
            const container = document.querySelector(`#chart_${stockCode}`).previousElementSibling;
            const activeButton = container.querySelector('button.active');
            const period = activeButton.textContent.includes('åˆ†é’Ÿ') ? 'minute' : 
                          activeButton.textContent.includes('æ—¥') ? 'daily' : 'weekly';
            await loadKlineChart(stockCode, period);
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
    }
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', () => {
    loadPortfolio();
});
</script>
{% endblock %}
