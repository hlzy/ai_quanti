{% extends "base.html" %}

{% block title %}æ¨¡å‹ç®¡ç† - AIé‡åŒ–è‚¡ç¥¨åˆ†æå·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .btn-warning {
        background: #f39c12;
        color: white;
    }
    
    .btn-warning:hover {
        background: #e67e22;
    }
    
    .badge-enabled {
        background: #67c23a;
        color: white;
    }
    
    .badge-disabled {
        background: #909399;
        color: white;
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        width: 90%;
        max-width: 600px;
    }
    
    .modal-header {
        margin-bottom: 20px;
    }
    
    .modal-header h3 {
        color: #333;
        font-size: 1.3rem;
    }
    
    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    thead {
        background: #f8f9fa;
    }
    
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    th {
        font-weight: 600;
        color: #555;
    }
    
    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .actions {
        display: flex;
        gap: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>ğŸ¤– AIæ¨¡å‹ç®¡ç†</h2>
        <button class="btn btn-primary" onclick="showAddModelModal()">
            â• æ·»åŠ æ¨¡å‹
        </button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>æ¨¡å‹ID</th>
                <th>æ¨¡å‹åç§°</th>
                <th>Visionæ”¯æŒ</th>
                <th>çŠ¶æ€</th>
                <th>æ’åº</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="modelTableBody">
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                    <div class="loading">åŠ è½½ä¸­</div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- æ·»åŠ æ¨¡å‹æ¨¡æ€æ¡† -->
<div id="addModelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ·»åŠ æ–°æ¨¡å‹</h3>
        </div>
        <form id="addModelForm">
            <div class="input-group">
                <label>æ¨¡å‹ID *</label>
                <input type="text" id="newModelId" required placeholder="ä¾‹å¦‚: deepseek/deepseek-chat">
                <small style="color: #909399; display: block; margin-top: 5px;">
                    è¯·è¾“å…¥OpenRouterå¹³å°çš„æ¨¡å‹IDï¼Œå¯åœ¨ <a href="https://openrouter.ai/docs/models" target="_blank">OpenRouteræ¨¡å‹åˆ—è¡¨</a> æŸ¥è¯¢
                </small>
            </div>
            <div class="input-group">
                <label>æ¨¡å‹åç§° *</label>
                <input type="text" id="newModelName" required placeholder="ä¾‹å¦‚: DeepSeek Chat">
            </div>
            <div class="input-group">
                <label>æ˜¾ç¤ºæ’åº</label>
                <input type="number" id="newDisplayOrder" value="0" min="0">
                <small style="color: #909399; display: block; margin-top: 5px;">
                    æ•°å­—è¶Šå°æ’åºè¶Šé å‰
                </small>
            </div>
            <div class="input-group">
                <label>æ”¯æŒVisionï¼ˆå›¾ç‰‡è¾“å…¥ï¼‰</label>
                <select id="newSupportsVision">
                    <option value="0">ä¸æ”¯æŒ</option>
                    <option value="1">æ”¯æŒ</option>
                </select>
                <small style="color: #909399; display: block; margin-top: 5px;">
                    æ˜¯å¦æ”¯æŒå›¾ç‰‡è¾“å…¥åŠŸèƒ½
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">æ·»åŠ </button>
            </div>
        </form>
    </div>
</div>

<!-- ç¼–è¾‘æ¨¡å‹æ¨¡æ€æ¡† -->
<div id="editModelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç¼–è¾‘æ¨¡å‹</h3>
        </div>
        <form id="editModelForm">
            <input type="hidden" id="editModelDbId">
            <div class="input-group">
                <label>æ¨¡å‹ID</label>
                <input type="text" id="editModelId" disabled style="background: #f5f5f5; cursor: not-allowed;">
                <small style="color: #909399; display: block; margin-top: 5px;">
                    æ¨¡å‹IDä¸å¯ä¿®æ”¹
                </small>
            </div>
            <div class="input-group">
                <label>æ¨¡å‹åç§° *</label>
                <input type="text" id="editModelName" required>
            </div>
            <div class="input-group">
                <label>çŠ¶æ€</label>
                <select id="editIsEnabled">
                    <option value="1">å¯ç”¨</option>
                    <option value="0">ç¦ç”¨</option>
                </select>
            </div>
            <div class="input-group">
                <label>æ˜¾ç¤ºæ’åº</label>
                <input type="number" id="editDisplayOrder" min="0">
            </div>
            <div class="input-group">
                <label>æ”¯æŒVisionï¼ˆå›¾ç‰‡è¾“å…¥ï¼‰</label>
                <select id="editSupportsVision">
                    <option value="0">ä¸æ”¯æŒ</option>
                    <option value="1">æ”¯æŒ</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    // ç­‰å¾…DOMåŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', function() {
        let models = [];
        
        // åŠ è½½æ¨¡å‹åˆ—è¡¨
        async function loadModels() {
            try {
                console.log('å¼€å§‹åŠ è½½æ¨¡å‹åˆ—è¡¨...');
                const response = await fetch('/api/admin/models');
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error('HTTPé”™è¯¯: ' + response.status);
                }
                
                const result = await response.json();
                console.log('APIå“åº”æ•°æ®:', result);
                
                if (!result.success) {
                    showMessage(result.message || 'åŠ è½½å¤±è´¥', 'error');
                    document.getElementById('modelTableBody').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #f56c6c;">åŠ è½½å¤±è´¥: ' + 
                        (result.message || 'æœªçŸ¥é”™è¯¯') + '</td></tr>';
                    return;
                }
                
                models = result.data || [];
                console.log('æˆåŠŸåŠ è½½æ¨¡å‹æ•°é‡:', models.length);
                renderModels();
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                document.getElementById('modelTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #f56c6c;">åŠ è½½å¤±è´¥: ' + 
                    error.message + '<br><small>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</small></td></tr>';
            }
        }
        
        // æ¸²æŸ“æ¨¡å‹åˆ—è¡¨
        function renderModels() {
            const tbody = document.getElementById('modelTableBody');
            
            if (models.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #909399;">æš‚æ— æ¨¡å‹é…ç½®</td></tr>';
                return;
            }
            
            const rows = models.map(function(model) {
                const statusClass = model.is_enabled ? 'enabled' : 'disabled';
                const statusText = model.is_enabled ? 'âœ“ å¯ç”¨' : 'âœ— ç¦ç”¨';
                const visionText = model.supports_vision ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
                const modelNameEscaped = String(model.model_name).replace(/'/g, "\\'");
                
                return '<tr>' +
                    '<td>' + model.id + '</td>' +
                    '<td><code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">' + model.model_id + '</code></td>' +
                    '<td><strong>' + model.model_name + '</strong></td>' +
                    '<td>' + visionText + '</td>' +
                    '<td><span class="badge badge-' + statusClass + '">' + statusText + '</span></td>' +
                    '<td>' + model.display_order + '</td>' +
                    '<td>' + formatDate(model.created_at) + '</td>' +
                    '<td><div class="actions">' +
                    '<button class="btn btn-warning btn-sm" onclick="window.showEditModal(' + model.id + ')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">ç¼–è¾‘</button>' +
                    '<button class="btn btn-danger btn-sm" onclick="window.deleteModel(' + model.id + ', \'' + modelNameEscaped + '\')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">åˆ é™¤</button>' +
                    '</div></td>' +
                    '</tr>';
            });
            
            tbody.innerHTML = rows.join('');
        }
        
        // æ˜¾ç¤ºæ·»åŠ æ¨¡å‹æ¨¡æ€æ¡†
        window.showAddModelModal = function() {
            document.getElementById('addModelModal').style.display = 'flex';
        };
        
        // å…³é—­æ·»åŠ æ¨¡æ€æ¡†
        function closeAddModal() {
            document.getElementById('addModelModal').style.display = 'none';
            document.getElementById('addModelForm').reset();
        }
        window.closeAddModal = closeAddModal;
        
        // æ·»åŠ æ¨¡å‹
        document.getElementById('addModelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const modelId = document.getElementById('newModelId').value.trim();
            const modelName = document.getElementById('newModelName').value.trim();
            const displayOrder = parseInt(document.getElementById('newDisplayOrder').value) || 0;
            const supportsVision = parseInt(document.getElementById('newSupportsVision').value) || 0;
            
            if (!modelId || !modelName) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_id: modelId,
                        model_name: modelName,
                        display_order: displayOrder,
                        supports_vision: supportsVision
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('æ·»åŠ æˆåŠŸ', 'success');
                    closeAddModal();
                    loadModels();
                } else {
                    showMessage(result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ æ¨¡å‹å¤±è´¥:', error);
                showMessage('æ·»åŠ æ¨¡å‹å¤±è´¥', 'error');
            }
        });
        
        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        window.showEditModal = function(modelId) {
            const model = models.find(function(m) { return m.id === modelId; });
            if (!model) return;
            
            document.getElementById('editModelDbId').value = model.id;
            document.getElementById('editModelId').value = model.model_id;
            document.getElementById('editModelName').value = model.model_name;
            document.getElementById('editIsEnabled').value = model.is_enabled;
            document.getElementById('editDisplayOrder').value = model.display_order;
            document.getElementById('editSupportsVision').value = model.supports_vision || 0;
            
            document.getElementById('editModelModal').style.display = 'flex';
        };
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModelModal').style.display = 'none';
            document.getElementById('editModelForm').reset();
        }
        window.closeEditModal = closeEditModal;
        
        // ç¼–è¾‘æ¨¡å‹
        document.getElementById('editModelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const dbId = document.getElementById('editModelDbId').value;
            const modelName = document.getElementById('editModelName').value.trim();
            const isEnabled = parseInt(document.getElementById('editIsEnabled').value);
            const displayOrder = parseInt(document.getElementById('editDisplayOrder').value) || 0;
            const supportsVision = parseInt(document.getElementById('editSupportsVision').value) || 0;
            
            if (!modelName) {
                showMessage('è¯·å¡«å†™æ¨¡å‹åç§°', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/models/' + dbId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_name: modelName,
                        is_enabled: isEnabled,
                        display_order: displayOrder,
                        supports_vision: supportsVision
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('æ›´æ–°æˆåŠŸ', 'success');
                    closeEditModal();
                    loadModels();
                } else {
                    showMessage(result.message || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°æ¨¡å‹å¤±è´¥:', error);
                showMessage('æ›´æ–°æ¨¡å‹å¤±è´¥', 'error');
            }
        });
        
        // åˆ é™¤æ¨¡å‹
        window.deleteModel = async function(modelId, modelName) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ¨¡å‹"' + modelName + '"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/models/' + modelId, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadModels();
                } else {
                    showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ¨¡å‹å¤±è´¥:', error);
                showMessage('åˆ é™¤æ¨¡å‹å¤±è´¥', 'error');
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ¨¡å‹åˆ—è¡¨
        loadModels();
    });
{% endblock %}
