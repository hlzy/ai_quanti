# å¤šç”¨æˆ·è´¦æˆ·ç®¡ç†åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†å®Œæ•´çš„å¤šç”¨æˆ·æ•°æ®éš”ç¦»ï¼Œæ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„ï¼š
1. **æŒä»“æ•°æ®**ï¼šç”¨æˆ·ä¹‹é—´çš„æŒä»“å®Œå…¨ç‹¬ç«‹
2. **è‡ªé€‰è‚¡åˆ—è¡¨**ï¼šæ¯ä¸ªç”¨æˆ·æœ‰è‡ªå·±çš„è‡ªé€‰è‚¡
3. **å¯¹è¯å†å²**ï¼šAIå¯¹è¯è®°å½•æŒ‰ç”¨æˆ·éš”ç¦»
4. **ç°é‡‘ä½™é¢**ï¼šç‹¬ç«‹çš„è´¦æˆ·ä½™é¢ç®¡ç†

## ğŸ”„ ç›®å½•ç»“æ„å˜æ›´

### å¯¹è¯å†å²è·¯å¾„å˜æ›´
- **æ—§æ ¼å¼**ï¼š`prompt_history/{stock_code}/history_{index}.md`
- **æ–°æ ¼å¼**ï¼š`prompt_history/{username}/{stock_code}/history_{index}.md`

ç¤ºä¾‹ï¼š
```
prompt_history/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ 688385.SH/
â”‚   â”‚   â”œâ”€â”€ history_1.md
â”‚   â”‚   â””â”€â”€ history_2.md
â”‚   â””â”€â”€ 300058.SZ/
â”‚       â””â”€â”€ history_1.md
â”œâ”€â”€ zhangsan/
â”‚   â””â”€â”€ 688385.SH/
â”‚       â””â”€â”€ history_1.md
â””â”€â”€ lisi/
    â””â”€â”€ 600036.SH/
        â””â”€â”€ history_1.md
```

## ğŸ—„ï¸ æ•°æ®åº“å˜æ›´

### 1. `watchlist` è¡¨
**æ–°å¢å­—æ®µ**ï¼š
- `user_id` (INTEGER, NOT NULL, DEFAULT 1)

**å”¯ä¸€çº¦æŸ**ï¼šä» `stock_code` æ”¹ä¸º `(user_id, stock_code)`

**ç´¢å¼•**ï¼š
- `idx_watchlist_user_id`
- `idx_watchlist_stock_code`

### 2. `positions` è¡¨
å·²æœ‰ `user_id` å­—æ®µï¼Œå”¯ä¸€çº¦æŸï¼š`(user_id, stock_code)`

### 3. `cash_balance` è¡¨
å·²æœ‰ `user_id` å­—æ®µï¼Œå”¯ä¸€çº¦æŸï¼š`user_id`

### 4. `chat_history` è¡¨
å·²æœ‰ `user_id` å­—æ®µï¼ŒæŸ¥è¯¢æ—¶æŒ‰ `user_id` å’Œ `stock_code` è¿‡æ»¤

## ğŸ”§ ä»£ç ä¿®æ”¹

### 1. Serviceå±‚ä¿®æ”¹

#### `watchlist_service.py`
```python
# æ‰€æœ‰æ–¹æ³•éƒ½å¢åŠ  user_id å‚æ•°
get_all_watchlist(user_id)
add_to_watchlist(user_id, stock_code, stock_name=None)
remove_from_watchlist(user_id, stock_code)
is_in_watchlist(user_id, stock_code)
```

#### `position_service.py`
```python
# æ‰€æœ‰æ–¹æ³•éƒ½å¢åŠ  user_id å‚æ•°
get_all_positions(user_id)
get_position(user_id, stock_code)
add_or_update_position(user_id, stock_code, stock_name, quantity, cost_price)
delete_position(user_id, stock_code)
update_position_price(user_id, stock_code, current_price)
update_all_positions_price(user_id)
get_cash_balance(user_id)
update_cash_balance(user_id, balance)
get_portfolio_summary(user_id)
init_cash_balance(user_id)  # æ–°å¢ï¼šåˆå§‹åŒ–ç”¨æˆ·ä½™é¢
```

#### `ai_service.py`
```python
# å¢åŠ  user_id å’Œ username å‚æ•°
save_chat_history(user_id, stock_code, role, content)
get_chat_history(user_id, stock_code, limit=50)
clear_chat_history(user_id, username, stock_code)
chat_with_history(user_id, username, stock_code, user_message)

# å†…éƒ¨æ–¹æ³•ä¹Ÿæ›´æ–°
_get_history_index(username, stock_code)
_save_prompt_history(username, stock_code, user_message, ai_response, replaced_message)
_replace_variables(user_id, stock_code, message)
_format_positions_data(user_id, positions_summary)
```

### 2. APIå±‚ä¿®æ”¹ (`app.py`)

æ‰€æœ‰éœ€è¦è®¿é—®ç”¨æˆ·æ•°æ®çš„APIç«¯ç‚¹éƒ½ä»sessionä¸­è·å– `user_id` å’Œ `username`ï¼š

```python
user_id = session['user_id']
username = session['username']
```

**ä¿®æ”¹çš„ç«¯ç‚¹**ï¼š
- `/api/watchlist` (GET, POST, DELETE)
- `/api/chat/history/<stock_code>` (GET)
- `/api/chat/send` (POST)
- `/api/chat/analyze/<stock_code>` (POST)
- `/api/chat/clear/<stock_code>` (DELETE)
- `/api/positions` (GET, POST, DELETE)
- `/api/positions/update-prices` (POST)
- `/api/cash` (GET, PUT)

## ğŸ“¦ æ•°æ®è¿ç§»

### è¿è¡Œè¿ç§»è„šæœ¬

```bash
cd /Users/sunjie/CodeBuddy/ai_quanti
python migrate_to_multiuser.py
```

### è¿ç§»æ­¥éª¤

è„šæœ¬ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

#### 1. æ•°æ®åº“è¿ç§»
- âœ… ä¸º `watchlist` è¡¨æ·»åŠ  `user_id` å­—æ®µ
- âœ… å°†æ‰€æœ‰ç°æœ‰æ•°æ®çš„ `user_id` è®¾ç½®ä¸º 1ï¼ˆadminç”¨æˆ·ï¼‰
- âœ… åˆ›å»ºå¿…è¦çš„ç´¢å¼•
- âœ… ç¡®ä¿ `positions`ã€`cash_balance`ã€`chat_history` è¡¨çš„æ—§æ•°æ®éƒ½å…³è”åˆ°admin

#### 2. æ–‡ä»¶ç³»ç»Ÿè¿ç§»
- âœ… åˆ›å»º `prompt_history/admin/` ç›®å½•
- âœ… å°†æ‰€æœ‰ `prompt_history/{stock_code}/` ç§»åŠ¨åˆ° `prompt_history/admin/{stock_code}/`
- âœ… ä¿ç•™å†å²è®°å½•æ–‡ä»¶

### âš ï¸ è¿ç§»å‰å‡†å¤‡

**å¼ºçƒˆå»ºè®®å¤‡ä»½**ï¼š
```bash
# å¤‡ä»½æ•°æ®åº“
cp data/quanti_stock.db data/quanti_stock.db.backup

# å¤‡ä»½å¯¹è¯å†å²
cp -r prompt_history prompt_history.backup
```

## ğŸš€ ä½¿ç”¨è¯´æ˜

### 1. ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·

1. ä½¿ç”¨adminè´¦æˆ·ç™»å½•
2. è®¿é—® `/admin` ç®¡ç†ç•Œé¢
3. ç‚¹å‡»"æ·»åŠ ç”¨æˆ·"åˆ›å»ºæ–°ç”¨æˆ·

### 2. æ–°ç”¨æˆ·ç™»å½•

æ¯ä¸ªæ–°ç”¨æˆ·ç™»å½•åä¼šè‡ªåŠ¨ï¼š
- åˆ›å»ºç‹¬ç«‹çš„å¯¹è¯å†å²ç›®å½•ï¼š`prompt_history/{username}/`
- åˆå§‹åŒ–ç°é‡‘ä½™é¢è®°å½•ï¼ˆ0å…ƒï¼‰
- å¯ä»¥æ·»åŠ è‡ªå·±çš„è‡ªé€‰è‚¡å’ŒæŒä»“

### 3. æ•°æ®éš”ç¦»éªŒè¯

```python
# ç”¨æˆ·Aæ·»åŠ è‡ªé€‰è‚¡
user_a_watchlist = watchlist_service.get_all_watchlist(user_id=2)

# ç”¨æˆ·Bæ·»åŠ è‡ªé€‰è‚¡
user_b_watchlist = watchlist_service.get_all_watchlist(user_id=3)

# äº’ä¸å½±å“
assert user_a_watchlist != user_b_watchlist
```

## ğŸ” æµ‹è¯•è¦ç‚¹

### 1. è‡ªé€‰è‚¡éš”ç¦»
- [ ] ç”¨æˆ·Aæ·»åŠ è‡ªé€‰è‚¡ï¼Œç”¨æˆ·Bçœ‹ä¸åˆ°
- [ ] ç”¨æˆ·Båˆ é™¤è‡ªé€‰è‚¡ï¼Œä¸å½±å“ç”¨æˆ·A

### 2. æŒä»“éš”ç¦»
- [ ] æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„æŒä»“åˆ—è¡¨
- [ ] ç°é‡‘ä½™é¢ç‹¬ç«‹ç®¡ç†
- [ ] æŠ•èµ„ç»„åˆæ±‡æ€»æŒ‰ç”¨æˆ·è®¡ç®—

### 3. å¯¹è¯å†å²éš”ç¦»
- [ ] æ¯ä¸ªç”¨æˆ·çš„å¯¹è¯å†å²ä¿å­˜åœ¨ç‹¬ç«‹ç›®å½•
- [ ] æ¸…é™¤å¯¹è¯å†å²åªæ¸…é™¤å½“å‰ç”¨æˆ·çš„è®°å½•
- [ ] å¯¹è¯å˜é‡æ›¿æ¢ä½¿ç”¨å½“å‰ç”¨æˆ·çš„æŒä»“æ•°æ®

### 4. æƒé™éªŒè¯
- [ ] æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—®ä»»ä½•API
- [ ] ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- [ ] ç®¡ç†å‘˜å¯ä»¥è®¿é—®ç”¨æˆ·ç®¡ç†ç•Œé¢

## ğŸ“Š æ•°æ®åº“æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥çœ‹æŸç”¨æˆ·çš„è‡ªé€‰è‚¡
SELECT * FROM watchlist WHERE user_id = 1;

-- æŸ¥çœ‹æŸç”¨æˆ·çš„æŒä»“
SELECT * FROM positions WHERE user_id = 1;

-- æŸ¥çœ‹æŸç”¨æˆ·çš„ç°é‡‘ä½™é¢
SELECT * FROM cash_balance WHERE user_id = 1;

-- æŸ¥çœ‹æŸç”¨æˆ·æŸè‚¡ç¥¨çš„å¯¹è¯å†å²
SELECT * FROM chat_history 
WHERE user_id = 1 AND stock_code = '688385.SH' 
ORDER BY created_at DESC;

-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„æŒä»“æ±‡æ€»
SELECT u.username, COUNT(p.id) as position_count, SUM(p.cost_price * p.quantity) as total_cost
FROM users u
LEFT JOIN positions p ON u.id = p.user_id
GROUP BY u.id;
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: è¿ç§»åæ‰¾ä¸åˆ°ä¹‹å‰çš„å¯¹è¯å†å²ï¼Ÿ
**A**: å¯¹è¯å†å²å·²ç§»åŠ¨åˆ° `prompt_history/admin/{stock_code}/` ç›®å½•ä¸‹ã€‚

### Q2: æ–°ç”¨æˆ·æ²¡æœ‰ç°é‡‘ä½™é¢ï¼Ÿ
**A**: æ–°ç”¨æˆ·é¦–æ¬¡æŸ¥è¯¢ä½™é¢æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸º0ï¼Œå¯ä»¥é€šè¿‡ `/api/cash` (PUT) æ›´æ–°ã€‚

### Q3: æ—§æ•°æ®éƒ½å±äºå“ªä¸ªç”¨æˆ·ï¼Ÿ
**A**: è¿ç§»è„šæœ¬å°†æ‰€æœ‰æ—§æ•°æ®å…³è”åˆ° `user_id=1`ï¼ˆadminç”¨æˆ·ï¼‰ã€‚

### Q4: å¦‚ä½•æ¢å¤æ—§çš„å•ç”¨æˆ·æ¨¡å¼ï¼Ÿ
**A**: ä»å¤‡ä»½æ¢å¤æ•°æ®åº“å’Œprompt_historyç›®å½•å³å¯ã€‚

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æƒé™ç»†åŒ–**ï¼šæ·»åŠ æ•°æ®æŸ¥çœ‹æƒé™ï¼ˆåªè¯»ç”¨æˆ·ï¼‰
2. **ç”¨æˆ·é…é¢**ï¼šé™åˆ¶æ¯ä¸ªç”¨æˆ·çš„æŒä»“æ•°é‡ã€è‡ªé€‰è‚¡æ•°é‡
3. **æ•°æ®å¯¼å‡º**ï¼šæ”¯æŒç”¨æˆ·å¯¼å‡ºè‡ªå·±çš„å†å²æ•°æ®
4. **å…±äº«åŠŸèƒ½**ï¼šå…è®¸ç”¨æˆ·ä¹‹é—´åˆ†äº«ç­–ç•¥å’Œåˆ†æ
5. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•ç”¨æˆ·çš„æ“ä½œå†å²

## âœ… å®ç°æ¸…å•

- [x] æ•°æ®åº“è¡¨ç»“æ„æ›´æ–°
- [x] watchlist_service å¤šç”¨æˆ·æ”¯æŒ
- [x] position_service å¤šç”¨æˆ·æ”¯æŒ
- [x] ai_service å¤šç”¨æˆ·æ”¯æŒ
- [x] app.py APIå±‚æ›´æ–°
- [x] æ•°æ®è¿ç§»è„šæœ¬
- [x] æ–‡æ¡£ç¼–å†™

## ğŸ¯ æµ‹è¯•è„šæœ¬

```bash
# å¯åŠ¨åº”ç”¨
python app.py

# æµ‹è¯•æµç¨‹ï¼š
# 1. ä½¿ç”¨adminç™»å½•
# 2. è®¿é—®/adminåˆ›å»ºæµ‹è¯•ç”¨æˆ· testuser
# 3. é€€å‡ºç™»å½•
# 4. ä½¿ç”¨testuserç™»å½•
# 5. æ·»åŠ è‡ªé€‰è‚¡ã€åˆ›å»ºæŒä»“
# 6. å‘é€AIå¯¹è¯
# 7. æ£€æŸ¥ prompt_history/testuser/ ç›®å½•æ˜¯å¦åˆ›å»º
# 8. é€€å‡ºç™»å½•ï¼Œå†ç”¨adminç™»å½•
# 9. éªŒè¯adminå’Œtestuserçš„æ•°æ®ç›¸äº’ç‹¬ç«‹
```

---

**æ›´æ–°æ—¥æœŸ**: 2026-02-20  
**ç‰ˆæœ¬**: 0.2  
**ä½œè€…**: AIé‡åŒ–è‚¡ç¥¨åˆ†æå·¥å…·å›¢é˜Ÿ
