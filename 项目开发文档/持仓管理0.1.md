# 持仓管理 0.1

## 功能说明

持仓管理模块用于记录和跟踪用户的股票持仓，包括持仓数量、成本价、当前价格、市值、盈亏情况等。

## 主要功能

### 1. 持仓录入
- 输入股票代码后，**自动获取股票名称**（也可手动修改）
- 输入持仓数量和成本价
- 添加持仓时**自动加入自选股**
- 支持更新已有持仓

### 2. 持仓信息展示
采用表格形式展示所有持仓：

| 列名 | 说明 |
|------|------|
| 股票代码 | 如 688385.SH |
| 股票名称 | 如 复旦微电 |
| 持仓数量 | 股数 |
| 成本价 | 买入平均价格 |
| 当前价 | 最新市场价格 |
| 市值 | 当前价 × 持仓数量 |
| 盈亏金额 | (当前价 - 成本价) × 持仓数量 |
| 盈亏比例 | (当前价 - 成本价) / 成本价 × 100% |
| 操作 | 更新、删除按钮 |

**盈亏显示规则：**
- 盈利：绿色显示，带 `+` 号
- 亏损：红色显示
- 持平：灰色显示

### 3. 价格更新
- **批量更新**：点击顶部"🔄 更新价格"按钮，更新所有持仓的最新价格
- **单独更新**：点击每行的"更新"按钮，只更新该股票的价格
- 更新后自动重新计算盈亏金额和比例

### 4. 资产汇总
顶部显示四个汇总卡片：
- 💰 **现金余额**：可用现金
- 📊 **持仓市值**：所有持仓的总市值
- 💼 **总资产**：现金 + 持仓市值
- 📈 **总盈亏**：所有持仓的盈亏总和（绿色为盈利，红色为亏损）

### 5. 自选股联动
- 添加持仓时自动加入自选股
- 在股票分析页面可查看持仓股票的K线图
- 统一的数据更新机制

## 界面设计

### 表格布局
- 清晰的表格展示，一目了然
- 响应式设计，自适应屏幕大小
- 鼠标悬停行高亮

### 汇总卡片
- 渐变色背景，视觉美观
- 大字号数值，易于阅读
- 盈亏卡片根据正负值自动变色

## 技术实现

### 后端服务
- `position_service.py`：持仓管理服务
  - 自动获取股票名称
  - 自动添加到自选股
  - SQLite兼容的UPSERT操作
  - 根据最新价格计算盈亏

### 价格更新逻辑
1. 调用 `stock_service.update_stock_data()` 获取最新数据
2. 从数据库读取最新的日K收盘价
3. 更新持仓表的 `current_price`、`profit_loss`、`profit_loss_pct` 字段
4. 重新加载页面显示最新数据

### 前端功能
- 自动获取股票名称（onblur事件）
- 表格数据动态渲染
- 实时盈亏计算和颜色显示
- 单个/批量更新价格

## 使用流程

### 添加持仓
1. 点击"➕ 添加持仓"按钮
2. 输入股票代码（如：688385.SH）
3. 自动获取股票名称（可手动修改）
4. 输入持仓数量和成本价
5. 点击确定，系统自动：
   - 保存持仓信息
   - 加入自选股
   - 显示在持仓表格中

### 更新价格
**方式一：批量更新**
- 点击"🔄 更新价格"按钮
- 系统依次更新所有持仓的价格
- 自动重新计算盈亏

**方式二：单独更新**
- 点击某行的"更新"按钮
- 只更新该股票的价格
- 更快速，适合关注特定股票

### 设置现金
1. 点击"💰 设置现金"按钮
2. 输入当前可用现金金额
3. 确定后更新总资产计算

## 注意事项

- 股票代码格式：上证股票如 `688385.SH`，深证股票如 `000001.SZ`
- 当前价默认等于成本价，点击更新后才显示真实市场价格
- 盈亏计算基于最新的日K收盘价
- 更新价格需要调用Tushare API，请注意频率限制
- 删除持仓不会从自选股中移除该股票
- 持仓市值 = 当前价 × 持仓数量
