# AI对话日志记录使用说明

## 🎯 功能概述

AI对话模块现已支持：
1. **变量占位符** - 在消息中使用 `{日K}`, `{MACD_日K}` 等变量
2. **自动数据替换** - 变量自动替换为真实股票数据
3. **完整日志记录** - 保存原始消息和替换后的完整Prompt到文件

---

## 📝 支持的变量

| 变量 | 说明 | 数据量 |
|------|------|--------|
| `{日K}` | 日K线数据 | 60天 |
| `{周K}` | 周K线数据 | 60周 |
| `{MACD_日K}` | 日K的MACD指标 | 60天 |
| `{1分钟K}` | 1分钟K线 | 暂不支持 |

---

## 💡 使用示例

### 示例1：分析日K数据

**输入**：
```
综合300058的{日K}，给我一个交易策略
```

**实际发送给AI的内容**：
```
综合300058的
"""
日期    开盘    收盘    最高    最低    成交量
2025-11-20    9.67    9.10    9.67    9.08    6,151,695
2025-11-21    9.02    9.29    9.74    8.70    9,444,260
... （共60天数据）
"""
，给我一个交易策略
```

### 示例2：分析MACD指标

**输入**：
```
请分析{MACD_日K}的信号，是否可以买入？
```

**实际发送给AI的内容**：
```
请分析
"""
日期    MACD    MACD信号线    MACD柱    RSI(6)    RSI(12)
2025-11-20    0.6487    0.4707    0.1780    66.86    63.42
2025-11-21    0.7234    0.5489    0.1745    68.23    65.01
... （共60天数据）
"""
的信号，是否可以买入？
```

### 示例3：组合多个变量

**输入**：
```
结合{日K}和{MACD_日K}，这支股票如何？
```

**效果**：同时包含60天的日K数据和MACD数据

---

## 📁 日志文件位置

### 目录结构

```
prompt_history/
├── 300058.SZ/
│   ├── history_1.md    # 第1轮对话
│   ├── history_2.md    # 清除后的第2轮
│   └── history_3.md
├── 688385.SH/
│   └── history_1.md
└── ...
```

### 文件内容

每个历史文件包含：
- **用户输入（原始）** - 带变量的原始消息
- **用户输入（替换后）** - 包含完整数据的消息
- **AI回复** - AI的完整回复
- **时间戳** - 对话时间
- **历史索引** - 当前轮次编号

---

## 🔄 历史索引说明

### 索引规则

- 初始索引：`history_1.md`
- 清除对话后：自动创建 `history_2.md`
- 读取历史：始终读取索引最大的文件

### 查看历史

```bash
# 查看某个股票的对话历史
cat prompt_history/300058.SZ/history_1.md

# 查看最新的对话历史
ls -lt prompt_history/300058.SZ/
```

---

## ⚡ 快速开始

### 1. 选择股票

在自选股列表中选择一个股票，如 `300058 蓝色光标`

### 2. 输入带变量的消息

```
综合{日K}，给我一个交易策略
```

### 3. 发送消息

点击"发送"或按 `Enter`

### 4. 查看日志

```bash
cat prompt_history/300058.SZ/history_1.md
```

---

## 🎯 最佳实践

### ✅ 推荐用法

```
# 清晰的指令 + 变量
综合{日K}，给我一个买卖点建议

# 多个变量组合
基于{日K}和{MACD_日K}，分析当前趋势

# 具体的问题
{MACD_日K}显示金叉了吗？
```

### ❌ 避免的用法

```
# 纯变量，没有指令
{日K}

# 变量拼写错误
综合{日k}数据    # 应该是 {日K}

# 不支持的变量
{日K线}           # 应该是 {日K}
```

---

## 🔍 控制台日志

发送带变量的消息时，控制台会输出：

```
📝 用户输入: 综合{日K}，给我一个交易策略
🔄 变量替换: ['日K']
✅ Prompt历史已保存: prompt_history/300058.SZ/history_1.md
```

---

## 📊 数据说明

### 日K数据格式

```
日期    开盘    收盘    最高    最低    成交量
```

### MACD数据格式

```
日期    MACD    MACD信号线    MACD柱    RSI(6)    RSI(12)
```

### 数据来源

- 从本地SQLite数据库读取
- 默认获取最近60天数据
- 如无数据，显示 `[暂无XX数据]`

---

## 🛠️ 故障排查

### 问题1：变量没有被替换

**原因**：
- 变量名拼写错误
- 数据库中没有该股票数据

**解决**：
1. 检查变量名（大小写敏感）
2. 点击"更新数据"按钮获取数据

### 问题2：文件没有生成

**原因**：
- 权限问题
- 目录不存在

**解决**：
```bash
# 手动创建目录
mkdir -p prompt_history

# 检查权限
chmod 755 prompt_history
```

### 问题3：历史索引不增加

**原因**：
- 未点击"清除对话"
- 同一轮对话会追加到同一文件

**解决**：
- 清除对话后索引会自动+1

---

## 📚 相关文档

- 详细调试报告：`项目开发报告/调试报告6-AI对话日志记录功能.md`
- 需求文档：`项目开发文档/AI对话功能模块0.2.md`
- 核心代码：`services/ai_service.py`

---

**功能状态**：✅ 已上线  
**更新时间**：2026/02/18
