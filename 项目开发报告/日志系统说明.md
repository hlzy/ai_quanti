# 日志系统说明

## 概述

本项目已集成完善的日志系统，所有关键操作和错误都会记录到 `log/` 目录下。

## 日志文件位置

```
ai_quanti/
└── log/
    ├── stock_service_2026-02-18.log    # 股票服务日志
    ├── ai_service_2026-02-18.log       # AI服务日志
    ├── position_service_2026-02-18.log # 持仓管理日志
    ├── watchlist_service_2026-02-18.log# 自选股日志
    └── app_2026-02-18.log              # 应用主日志
```

日志文件按日期自动分割，每天生成新的日志文件。

## 日志级别

日志系统使用标准的Python logging级别：

- **DEBUG**: 详细的调试信息（仅记录到文件）
- **INFO**: 一般信息（仅记录到文件）
- **WARNING**: 警告信息（记录到文件 + 显示在控制台）
- **ERROR**: 错误信息（记录到文件 + 显示在控制台）

## 主要功能

### 1. API权限错误处理

当Tushare API权限不足时（如分钟K线接口），系统会：
- 记录详细错误信息到日志文件
- 在控制台显示友好的警告提示
- **不会导致程序崩溃**

示例日志：
```
2026-02-18 22:36:08 - stock_service - WARNING - 分钟K线权限不足 - 股票: 300058.SZ, 频率: 1min
错误信息: ERROR.
提示: 该接口需要Tushare高级权限，详情: https://tushare.pro/document/1?doc_id=108
```

控制台显示：
```
⚠️ 300058.SZ 无1min分钟K线数据（可能需要权限）
```

### 2. API限流保护

系统自动对Tushare API调用进行限流，避免触发频率限制：
- 分钟K线接口：每30秒最多调用1次
- 自动等待并记录日志

示例日志：
```
2026-02-18 22:36:10 - stock_service - INFO - API限流: pro_bar_1min 等待 25.3 秒
```

### 3. 详细的操作日志

所有关键操作都有日志记录：

**股票信息查询**
```
2026-02-18 22:36:08 - stock_service - INFO - 查询到股票: 仕佳光子 (688313.SH)
```

**数据获取**
```
2026-02-18 22:36:10 - stock_service - INFO - 获取日K线成功: 688313.SH, 数据条数: 60
```

**AI调用**
```
2026-02-18 22:36:15 - ai_service - INFO - AI响应成功, tokens: {'total_tokens': 1234, 'input_tokens': 800, 'output_tokens': 434}
```

### 4. 异常堆栈记录

当发生未预期的错误时，完整的异常堆栈会被记录到日志文件，方便调试：

```python
2026-02-18 22:36:20 - stock_service - ERROR - 获取日K线失败: 688313.SH, 20260201 - 20260218
Traceback (most recent call last):
  File "/Users/sunjie/CodeBuddy/ai_quanti/services/stock_service.py", line 180, in fetch_daily_data
    df = self.pro.daily(ts_code=ts_code, start_date=start_date, end_date=end_date)
...
```

## 使用方法

### 在代码中使用日志

```python
from utils.logger import stock_logger, ai_logger, app_logger

# 记录调试信息（仅文件）
stock_logger.debug("查询股票信息: 688313.SH")

# 记录一般信息（仅文件）
stock_logger.info("获取数据成功")

# 记录警告（文件+控制台）
stock_logger.warning("数据为空")

# 记录错误（文件+控制台，包含堆栈）
try:
    # 某些操作
    pass
except Exception as e:
    stock_logger.error("操作失败", exc_info=True)
```

### 查看日志

```bash
# 查看今天的股票服务日志
cat log/stock_service_2026-02-18.log

# 实时监控日志
tail -f log/stock_service_2026-02-18.log

# 搜索错误
grep ERROR log/*.log

# 搜索权限相关问题
grep "权限" log/*.log
```

## 日志格式

每条日志的格式为：
```
时间 - 日志器名称 - 级别 - 消息
```

示例：
```
2026-02-18 22:36:08 - stock_service - INFO - Stock service initialized successfully
```

## 常见问题排查

### 1. 分钟K线权限问题

**症状**: 控制台显示 `⚠️ XXX 无1min分钟K线数据（可能需要权限）`

**排查**:
```bash
grep "分钟K线权限不足" log/stock_service_*.log
```

**解决**: 
- 升级Tushare权限
- 或避免使用分钟K线功能

### 2. API调用失败

**症状**: 请求超时或失败

**排查**:
```bash
grep -A 5 "API调用失败" log/*.log
```

**解决**: 检查网络连接和API密钥

### 3. AI服务异常

**症状**: AI回复失败

**排查**:
```bash
grep -A 10 "AI服务异常" log/ai_service_*.log
```

**解决**: 检查通义千问API配置和余额

## 配置

日志配置在 `utils/logger.py` 中：

```python
# 修改日志级别
logger.setLevel(logging.DEBUG)  # DEBUG, INFO, WARNING, ERROR

# 修改文件级别
file_handler.setLevel(logging.DEBUG)

# 修改控制台级别
console_handler.setLevel(logging.WARNING)

# 修改日志格式
formatter = logging.Formatter(
    '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

## 注意事项

1. **日志文件会随时间增长**：建议定期清理旧日志
2. **敏感信息**：日志中不包含API密钥等敏感信息
3. **性能影响**：日志记录对性能影响极小
4. **Git忽略**：`log/` 目录已添加到 `.gitignore`

## 测试

运行测试脚本验证日志系统：

```bash
python test_logging.py
```

测试内容：
- ✓ 基本日志记录
- ✓ 权限错误处理
- ✓ 日志文件创建
- ✓ 异常不导致崩溃
