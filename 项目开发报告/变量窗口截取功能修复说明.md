# 变量窗口截取功能修复说明

## 问题描述

用户发现在使用 `{日K_10天}` 变量时，虽然指定了10天窗口，但实际返回的数据是60天（默认值），而不是期望的10天。

通过分析 `@prompt_history/688313.SH/history_2.md` 文件发现，使用 `日K_10天` 变量时返回了62条数据，远超预期的10条。

## 根本原因

经过调试发现两个问题：

### 1. 正则表达式匹配问题

原始正则表达式：
```python
r'(1分钟K|日K|周K)(_[^_\s]*)?(_\d+天)?(_[^_\s\n]+)?'
```

存在的问题：
- `日K_10天` 会被错误匹配为：K线类型=`日K`，股票=`10天`，窗口=空
- 因为 `_[^_\s]*` 可以匹配任何内容包括"10天"，比 `_\d+天` 更贪婪

### 2. 数据未二次截取

虽然 `get_stock_data_from_db` 方法在数据库层面使用 `LIMIT` 正确限制了返回条数，但在某些情况下（如历史记录）可能返回更多数据，缺少二次保险机制。

## 解决方案

### 1. 优化正则表达式

采用先匹配整体，再分步解析的策略：

```python
# 新的正则表达式 - 匹配完整的变量字符串
pattern = r'(1分钟K|日K|周K)(?:(?:_[^_\s\n]+)+)?'

# 然后按 _ 分割并从后向前解析
parts = full_match.split('_')
kline_type = parts[0]

# 从后向前识别：指标 -> 窗口 -> 股票
# 窗口：符合 \d+天 格式
# 指标：最后一部分且不是 \d+天 格式
# 股票：剩余的部分
```

这种方法的优势：
- 支持任意格式的股票代码/名称（包括中文、数字等）
- 准确识别 `\d+天` 格式的窗口参数
- 支持复合股票名（如包含下划线）

### 2. 添加二次截取保险

在获取数据后，添加额外的截取逻辑：

```python
# 确保数据条数不超过window_days（二次保险）
if len(data) > window_days:
    data = data[-window_days:]

# 指标数据同样处理
if indicator_data and len(indicator_data) > window_days:
    indicator_data = indicator_data[-window_days:]
```

## 修改文件

- `services/ai_service.py` - `_replace_variables()` 方法

## 测试验证

创建了完整的测试脚本 `test_variable_window_fix.py`，测试用例包括：

| 输入变量 | 描述 | 期望数据行数 | 测试结果 |
|---------|------|------------|---------|
| `日K_10天` | 无股票名，有窗口 | 10 | ✅ 通过 |
| `日K_30天` | 无股票名，有窗口 | 30 | ✅ 通过 |
| `日K_688385_10天` | 有股票代码，有窗口 | 10 | ✅ 通过 |
| `周K_60天` | 周K数据 | 60 | ✅ 通过 |
| `日K_10天_MACD` | 有窗口和指标 | 20 (K线+指标) | ✅ 通过 |
| `日K_688313_20天_EMA` | 完整格式 | 40 (K线+指标) | ✅ 通过 |

所有测试均通过！

## 支持的变量格式

修复后支持以下格式：

```
1. 日K_10天              → 当前股票，10天数据
2. 日K_688385_10天       → 指定股票，10天数据
3. 周K_60天              → 当前股票，60天数据
4. 日K_10天_MACD         → 当前股票，10天数据+MACD指标
5. 日K_688313_20天_EMA   → 指定股票，20天数据+EMA指标
6. 1分钟K                → 当前股票，默认分钟数
```

## 注意事项

1. **双下划线问题**：`日K__30天` 不会被正确识别，用户应避免使用双下划线
2. **股票名查询**：使用股票名时（如"复旦微电"），必须在系统中存在才能正确查询
3. **指标数据**：当请求指标时，返回的数据包含K线数据和指标数据，总行数是window_days的2倍
4. **默认窗口**：
   - 日K：60天
   - 周K：360天
   - 1分钟K：1440分钟（2天）

## 运行测试

```bash
cd /Users/sunjie/CodeBuddy/ai_quanti
source venv/bin/activate
python test_variable_window_fix.py
```

---

**修复日期**: 2026/02/18
**修复人员**: AI Assistant
