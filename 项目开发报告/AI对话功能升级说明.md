# AI对话功能升级说明

## 更新时间
2026年2月18日

## 功能概览

本次升级对AI对话功能进行了重要扩展，增加了对话模版选择和智能变量解析功能，提升了用户体验和对话效率。

---

## 一、对话模版选择功能

### 1.1 功能描述

当对话框为空（无对话记录）时，用户可以从已保存的对话模版中选择，快速填充常用的分析问题。

### 1.2 使用方法

1. **触发条件**：在自选股页面选择一只股票后，如果该股票的对话记录为空
2. **操作步骤**：
   - 点击对话区域显示的"选择对话模版"按钮
   - 在弹出的模版列表中选择需要的模版
   - 模版内容自动填充到输入框
   - 点击"发送"按钮即可使用

### 1.3 技术实现

- **前端**：模态框展示模版列表，支持点击选择
- **后端**：调用 `/api/templates` 接口获取模版数据
- **数据来源**：从"对话模版"管理页面创建的模版

---

## 二、变量查看弹窗

### 2.1 功能描述

在清除按钮左侧增加了一个"?"图标按钮，点击后显示所有可用变量的格式说明和使用示例。

### 2.2 变量格式

```
K线类型_股票_窗口_指标
```

#### 参数说明：

1. **K线类型**（必填）
   - 可选值：`1分钟K`、`日K`、`周K`

2. **股票**（选填）
   - 支持A股、指数、ETF的代码或名称
   - 不填则表示当前选中的股票

3. **窗口**（选填）
   - 格式：`30天`、`360天` 等
   - 默认值：
     - 日K：60天
     - 周K：360天
     - 1分钟K：2天（1440分钟）

4. **指标**（选填、可多个）
   - 支持：`MACD`、`EMA`、`RSI`
   - 多个指标用 `&` 分割，如：`MACD&EMA`

### 2.3 使用示例

#### 示例1：完整参数
```
日K_复旦微电_30天_MACD&EMA
```
**说明**：获取复旦微电（688385）最近30天的日K线数据，包含基础K线（日期、开盘、收盘、最高、最低、成交量）以及MACD和EMA指标。

#### 示例2：省略股票参数
```
周K__360天_RSI
```
**说明**：使用当前选中的股票，获取最近360天的周K线数据和RSI指标。（注意：两个连续的下划线表示省略股票参数）

#### 示例3：仅指定K线类型
```
1分钟K
```
**说明**：获取当前选中股票最近2天的1分钟K线数据，不包含技术指标。

---

## 三、变量解析功能

### 3.1 解析逻辑

系统在发送用户消息前，会自动识别并替换消息中的变量格式：

1. **正则匹配**：识别符合 `K线类型_股票_窗口_指标` 格式的变量
2. **参数解析**：提取K线类型、股票代码、窗口天数、指标列表
3. **数据查询**：从数据库获取对应的K线数据和技术指标
4. **格式化输出**：将数据转换为表格格式
5. **变量替换**：用实际数据替换原始变量

### 3.2 输出格式

#### K线数据表格：
```
日期        开盘    收盘    最高    最低    成交量
2026-02-18  45.60   46.20   46.50   45.30   1,234,567
...
```

#### MACD指标表格：
```
日期        MACD      MACD信号线  MACD柱
2026-02-18  0.1234    0.1100      0.0134
...
```

#### EMA指标表格：
```
日期        EMA(12)   EMA(26)
2026-02-18  45.80     45.50
...
```

#### RSI指标表格：
```
日期        RSI(6)    RSI(12)   RSI(24)
2026-02-18  62.50     58.30     55.20
...
```

### 3.3 示例对话

**用户输入**：
```
分析一下 日K__30天_MACD 的走势，判断是否有金叉或死叉信号。
```

**系统处理**（自动替换后）：
```
分析一下 
"""
日期        开盘    收盘    最高    最低    成交量
2026-01-20  44.50   45.10   45.30   44.20   890,000
2026-01-21  45.00   45.60   45.80   44.90   1,020,000
...

MACD指标:
日期        MACD      MACD信号线  MACD柱
2026-01-20  0.0850    0.0920      -0.0070
2026-01-21  0.0980    0.0930      0.0050
...
"""
的走势，判断是否有金叉或死叉信号。
```

**AI回复**：
基于提供的数据进行MACD分析...

---

## 四、技术细节

### 4.1 前端改动

**文件**：`templates/index.html`

1. **新增UI元素**：
   - "?" 帮助按钮（清除按钮左侧）
   - 变量帮助模态框
   - 模版选择模态框
   - 模版选择按钮（对话为空时显示）

2. **新增JavaScript函数**：
   - `showVariablesHelp()` - 显示变量帮助
   - `closeVariablesModal()` - 关闭变量帮助
   - `showTemplateSelector()` - 显示模版选择器
   - `closeTemplateModal()` - 关闭模版选择器
   - `selectTemplate(templateId)` - 选择并填充模版

3. **样式优化**：
   - 模态框样式
   - 模版列表样式
   - 变量帮助内容样式

### 4.2 后端改动

**文件**：`services/ai_service.py`

1. **重构 `_replace_variables()` 方法**：
   - 支持新的变量格式解析
   - 正则表达式匹配 `K线类型_股票_窗口_指标`
   - 参数提取和默认值处理
   - 多指标支持（用 `&` 分割）

2. **新增格式化方法**：
   - `_format_ema_data()` - 格式化EMA数据
   - `_format_rsi_data()` - 格式化RSI数据
   - 重构 `_format_macd_data()` - 简化MACD数据输出

3. **数据查询优化**：
   - 支持跨股票查询（指定股票参数）
   - 灵活的窗口大小设置
   - 按需加载技术指标

### 4.3 数据流程

```
用户输入 → 前端发送 → 后端接收
    ↓
变量解析（_replace_variables）
    ↓
提取参数 → 查询K线数据 → 查询指标数据
    ↓
格式化数据（表格字符串）
    ↓
替换原始变量 → 构建AI消息
    ↓
调用通义千问API → 获取AI回复
    ↓
保存对话记录 → 返回前端显示
```

---

## 五、使用建议

### 5.1 对话模版管理

1. 在"对话模版"页面提前创建常用的分析问题
2. 模版内容可以包含变量格式，实现动态数据查询
3. 建议按分析类型分类模版（趋势分析、指标分析、综合评估等）

### 5.2 变量使用技巧

1. **简洁优先**：如果使用当前股票和默认窗口，可以省略参数
   - `日K` 等价于 `日K__60天_`
   
2. **组合指标**：同时查看多个指标更全面
   - `日K__30天_MACD&EMA&RSI`
   
3. **跨股票对比**：在同一对话中比较不同股票
   ```
   对比一下 日K_688385_30天_MACD 和 日K_000001_30天_MACD 的走势差异
   ```

4. **分阶段分析**：先看短期再看长期
   ```
   分析一下短期（日K__30天_MACD）和长期（周K__360天_MACD）的趋势是否一致
   ```

### 5.3 注意事项

1. **数据更新**：使用变量前，确保已更新股票数据（点击"更新数据"按钮）
2. **指标支持**：目前只有日K线支持技术指标（MACD、EMA、RSI）
3. **窗口限制**：窗口天数不宜过大，建议控制在合理范围内
4. **格式规范**：变量格式必须严格按照 `K线类型_股票_窗口_指标` 的顺序

---

## 六、示例对话场景

### 场景1：基础趋势分析
```
用户：分析一下 日K__30天 的走势，判断当前趋势。

AI：根据最近30天的日K线数据...
```

### 场景2：指标综合分析
```
用户：帮我看看 日K__60天_MACD&RSI，有没有买入机会？

AI：从MACD和RSI指标来看...
```

### 场景3：多周期对比
```
用户：对比一下 日K__30天_MACD 和 周K__360天_MACD，长短期趋势是否一致？

AI：短期（30天日K）显示...，而长期（360天周K）显示...
```

### 场景4：跨股票对比
```
用户：对比一下 日K_688385__MACD 和 日K_000001__MACD，哪个技术形态更好？

AI：复旦微电（688385）的MACD显示...，而上证指数（000001）的MACD显示...
```

---

## 七、未来优化方向

1. **更多指标支持**：KDJ、BOLL、CCI等
2. **自定义指标参数**：如 `MACD(12,26,9)` 自定义周期
3. **数据可视化变量**：在对话中直接嵌入图表
4. **智能提示**：输入时自动提示可用变量格式
5. **模版变量预览**：选择模版时预览替换后的效果

---

*本文档由AI量化分析系统自动生成*
