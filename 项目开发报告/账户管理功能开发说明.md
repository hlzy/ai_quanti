# è´¦æˆ·ç®¡ç†åŠŸèƒ½å¼€å‘è¯´æ˜

## âœ… å·²å®Œæˆå†…å®¹

### 1. æ•°æ®åº“å±‚é¢
- âœ… åˆ›å»ºusersè¡¨ï¼ˆç”¨æˆ·ä¿¡æ¯è¡¨ï¼‰
- âœ… ä¿®æ”¹positionsè¡¨æ·»åŠ user_idå­—æ®µ
- âœ… ä¿®æ”¹cash_balanceè¡¨æ·»åŠ user_idå­—æ®µ  
- âœ… ä¿®æ”¹chat_historyè¡¨æ·»åŠ user_idå­—æ®µ

### 2. æœåŠ¡å±‚é¢
- âœ… åˆ›å»ºuser_service.pyç”¨æˆ·ç®¡ç†æœåŠ¡
  - ç”¨æˆ·è®¤è¯
  - åˆ›å»ºç”¨æˆ·
  - åˆ é™¤ç”¨æˆ·
  - ä¿®æ”¹å¯†ç 
  - è·å–ç”¨æˆ·åˆ—è¡¨

### 3. é¡µé¢å’Œè·¯ç”±
- âœ… åˆ›å»ºlogin.htmlç™»å½•é¡µé¢
- âœ… åˆ›å»ºadmin.htmlç®¡ç†å‘˜é¡µé¢
- âœ… æ·»åŠ è®¤è¯è£…é¥°å™¨ï¼ˆlogin_required, admin_requiredï¼‰
- âœ… æ·»åŠ ç™»å½•/ç™»å‡º/ä¿®æ”¹å¯†ç API
- âœ… æ·»åŠ ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†API
- âœ… ä¸ºæ‰€æœ‰éœ€è¦çš„è·¯ç”±æ·»åŠ @login_requiredè£…é¥°å™¨

### 4. å¤šç”¨æˆ·éš”ç¦»ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
- âœ… app.pyä¸­æ‰€æœ‰APIè·¯ç”±å·²æ·»åŠ user_idå‚æ•°ä¼ é€’
- âš ï¸ éœ€è¦ä¿®æ”¹position_service.pyçš„æ–¹æ³•æ”¯æŒuser_id
- âš ï¸ éœ€è¦ä¿®æ”¹ai_service.pyçš„æ–¹æ³•æ”¯æŒuser_id

## ğŸ”¨ éœ€è¦å®Œæˆçš„ä¿®æ”¹

### 1. position_service.py - æ·»åŠ user_idæ”¯æŒ

éœ€è¦ä¿®æ”¹ä»¥ä¸‹æ–¹æ³•ï¼š
```python
# åŸæ–¹æ³•
def get_all_positions(self):
def get_position(self, stock_code):
def add_or_update_position(self, stock_code, stock_name, quantity, cost_price):
def delete_position(self, stock_code):
def update_position_price(self, stock_code, current_price):
def update_all_positions_price(self):
def get_cash_balance(self):
def update_cash_balance(self, balance):
def get_portfolio_summary(self):

# ä¿®æ”¹ä¸º
def get_all_positions(self, user_id):
def get_position(self, stock_code, user_id):
def add_or_update_position(self, stock_code, stock_name, quantity, cost_price, user_id):
def delete_position(self, stock_code, user_id):
def update_position_price(self, stock_code, current_price, user_id):
def update_all_positions_price(self, user_id):
def get_cash_balance(self, user_id):
def update_cash_balance(self, balance, user_id):
def get_portfolio_summary(self, user_id):
```

### 2. ai_service.py - æ·»åŠ user_idæ”¯æŒ

éœ€è¦ä¿®æ”¹ä»¥ä¸‹æ–¹æ³•ï¼š
```python
# åŸæ–¹æ³•
def get_chat_history(self, stock_code):
def save_chat_history(self, stock_code, role, content):
def clear_chat_history(self, stock_code):
def chat_with_history(self, stock_code, message):

# ä¿®æ”¹ä¸º
def get_chat_history(self, stock_code, user_id):
def save_chat_history(self, stock_code, role, content, user_id):
def clear_chat_history(self, stock_code, user_id):
def chat_with_history(self, stock_code, message, user_id):
```

### 3. å‰ç«¯é¡µé¢ä¿®æ”¹

éœ€è¦ä¿®æ”¹ä»¥ä¸‹é¡µé¢æ·»åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥å’Œç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼š
- index.html - æ·»åŠ å¯¼èˆªæ ç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’®
- positions.html - æ·»åŠ å¯¼èˆªæ ç”¨æˆ·ä¿¡æ¯
- templates.html - æ·»åŠ å¯¼èˆªæ ç”¨æˆ·ä¿¡æ¯
- database.html - æ·»åŠ å¯¼èˆªæ ç”¨æˆ·ä¿¡æ¯

### 4. å¯†ç ä¿®æ”¹åŠŸèƒ½

å‰ç«¯éœ€è¦æ·»åŠ å¯†ç ä¿®æ”¹ç•Œé¢ï¼Œå¯ä»¥åœ¨å¯¼èˆªæ æ·»åŠ "ä¿®æ”¹å¯†ç "é€‰é¡¹ã€‚

## ğŸ“‹ æ•°æ®åº“è¿ç§»

ç”±äºä¿®æ”¹äº†è¡¨ç»“æ„ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹SQLæ¥è¿ç§»ç°æœ‰æ•°æ®ï¼š

```sql
-- 1. ä¸ºpositionsè¡¨æ·»åŠ user_idå­—æ®µï¼ˆé»˜è®¤å€¼ä¸º1ï¼Œå¯¹åº”ç®¡ç†å‘˜ï¼‰
ALTER TABLE positions ADD COLUMN user_id INT NOT NULL DEFAULT 1;
ALTER TABLE positions DROP INDEX uk_stock_code;
ALTER TABLE positions ADD UNIQUE KEY uk_user_stock (user_id, stock_code);
ALTER TABLE positions ADD INDEX idx_user_id (user_id);

-- 2. ä¸ºcash_balanceè¡¨æ·»åŠ user_idå­—æ®µ
ALTER TABLE cash_balance ADD COLUMN user_id INT NOT NULL DEFAULT 1;
ALTER TABLE cash_balance ADD UNIQUE KEY uk_user_id (user_id);

-- 3. ä¸ºchat_historyè¡¨æ·»åŠ user_idå­—æ®µ
ALTER TABLE chat_history ADD COLUMN user_id INT NOT NULL DEFAULT 1;
ALTER TABLE chat_history ADD INDEX idx_user_id (user_id);

-- 4. åˆ›å»ºusersè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password_hash VARCHAR(64) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 5. åˆå§‹åŒ–ç®¡ç†å‘˜è´¦æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
INSERT IGNORE INTO users (username, password_hash, role, created_at)
VALUES ('admin', SHA2('admin123', 256), 'admin', NOW());
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨æ­¥éª¤

1. **æ•°æ®åº“åˆå§‹åŒ–**
```bash
cd /Users/sunjie/CodeBuddy/ai_quanti
source venv/bin/activate
python -c "from database import db_manager; db_manager.init_database()"
```

2. **å¯åŠ¨åº”ç”¨**
```bash
python app.py
```

3. **è®¿é—®ç™»å½•é¡µé¢**
- URL: http://localhost:5000/login
- ç®¡ç†å‘˜è´¦æˆ·: admin / admin123

## ğŸ“š åŠŸèƒ½è¯´æ˜

### ç”¨æˆ·è§’è‰²

#### ç®¡ç†å‘˜ï¼ˆadminï¼‰
- å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç”¨æˆ·
- å¯ä»¥åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆç®¡ç†å‘˜/æ™®é€šç”¨æˆ·ï¼‰
- å¯ä»¥åˆ é™¤æ™®é€šç”¨æˆ·
- å¯ä»¥ä¿®æ”¹è‡ªå·±çš„å¯†ç 
- å¯ä»¥è®¿é—®æ‰€æœ‰åŠŸèƒ½

#### æ™®é€šç”¨æˆ·ï¼ˆuserï¼‰
- åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æŒä»“
- åªèƒ½æŸ¥çœ‹è‡ªå·±çš„AIå¯¹è¯è®°å½•
- å¯ä»¥ä¿®æ”¹è‡ªå·±çš„å¯†ç 
- ä¸èƒ½è®¿é—®ç”¨æˆ·ç®¡ç†åŠŸèƒ½

### æ•°æ®éš”ç¦»

- æ¯ä¸ªç”¨æˆ·çš„æŒä»“æ•°æ®å®Œå…¨éš”ç¦»
- æ¯ä¸ªç”¨æˆ·çš„AIå¯¹è¯è®°å½•å®Œå…¨éš”ç¦»
- æ¯ä¸ªç”¨æˆ·çš„ç°é‡‘ä½™é¢ç‹¬ç«‹ç®¡ç†
- è‡ªé€‰è‚¡åˆ—è¡¨ï¼ˆæš‚æ—¶å…¨å±€å…±äº«ï¼Œå¯åç»­æ”¹ä¸ºç”¨æˆ·éš”ç¦»ï¼‰

### å®‰å…¨æªæ–½

- å¯†ç ä½¿ç”¨SHA-256å“ˆå¸Œå­˜å‚¨
- Sessionæœ‰æ•ˆæœŸ24å°æ—¶
- æ‰€æœ‰éœ€è¦ç™»å½•çš„é¡µé¢éƒ½æœ‰@login_requiredè£…é¥°å™¨ä¿æŠ¤
- ç®¡ç†å‘˜åŠŸèƒ½æœ‰@admin_requiredè£…é¥°å™¨ä¿æŠ¤
- ä¸èƒ½åˆ é™¤é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·

## ğŸ” APIæ–‡æ¡£

### è®¤è¯ç›¸å…³

#### POST /api/auth/login
ç™»å½•
```json
Request: {"username": "admin", "password": "admin123"}
Response: {"success": true, "message": "ç™»å½•æˆåŠŸ", "user": {...}}
```

#### GET /api/auth/current_user
è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç™»å½•ï¼‰
```json
Response: {"id": 1, "username": "admin", "role": "admin"}
```

#### POST /api/auth/change_password
ä¿®æ”¹å¯†ç ï¼ˆéœ€è¦ç™»å½•ï¼‰
```json
Request: {"old_password": "admin123", "new_password": "newpassword"}
Response: {"success": true, "message": "å¯†ç ä¿®æ”¹æˆåŠŸ"}
```

#### GET /logout
é€€å‡ºç™»å½•

### ç®¡ç†å‘˜ç›¸å…³ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

#### GET /api/admin/users
è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨

#### POST /api/admin/users
åˆ›å»ºæ–°ç”¨æˆ·
```json
Request: {"username": "test", "password": "123456", "role": "user"}
Response: {"success": true, "message": "ç”¨æˆ·åˆ›å»ºæˆåŠŸ", "user_id": 2}
```

#### DELETE /api/admin/users/<user_id>
åˆ é™¤ç”¨æˆ·
```json
Response: {"success": true, "message": "ç”¨æˆ·åˆ é™¤æˆåŠŸ"}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œ**ï¼šéœ€è¦å…ˆåˆå§‹åŒ–æ•°æ®åº“ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºadminè´¦æˆ·
2. **å¯†ç å®‰å…¨**ï¼šå»ºè®®é¦–æ¬¡ç™»å½•åä¿®æ”¹adminå¯†ç 
3. **æ•°æ®è¿ç§»**ï¼šå¦‚æœå·²æœ‰æ—§æ•°æ®ï¼Œéœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»SQL
4. **Sessioné…ç½®**ï¼šSECRET_KEYéœ€è¦åœ¨.envä¸­é…ç½®ï¼Œç”¨äºsessionåŠ å¯†

## ğŸ“ TODO

- [ ] ä¿®æ”¹position_service.pyæ”¯æŒå¤šç”¨æˆ·
- [ ] ä¿®æ”¹ai_service.pyæ”¯æŒå¤šç”¨æˆ·
- [ ] å‰ç«¯é¡µé¢æ·»åŠ ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
- [ ] æ·»åŠ å¯†ç ä¿®æ”¹ç•Œé¢
- [ ] è‡ªé€‰è‚¡åŠŸèƒ½æ”¹ä¸ºç”¨æˆ·éš”ç¦»ï¼ˆå¯é€‰ï¼‰
- [ ] æ·»åŠ ç”¨æˆ·æ´»åŠ¨æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
- [ ] æ·»åŠ å¿˜è®°å¯†ç åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
