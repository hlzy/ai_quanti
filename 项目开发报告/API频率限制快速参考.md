# API频率限制解决方案 - 快速参考

## 🎯 核心原则

**一句话总结**：前端只读缓存，API调用由定时任务统一管理

---

## 🔄 数据更新方式

### 1. 前端查看数据（推荐）
```
选择股票 → 从数据库读取 → 瞬间显示
```
- ✅ 无API调用
- ✅ 响应速度快
- ✅ 无频率限制

### 2. 手动更新数据
```
点击"更新数据" → 调用Tushare API → 保存数据库 → 刷新显示
```
- ⏱️ 需要2-5秒
- 📊 消耗API配额
- ⚠️ 避免频繁点击

### 3. 自动定时更新（后台）
```
整5分钟触发（12:00、12:05...） → 更新所有自选股
```
- ⏰ 统一时间触发
- 🔄 自动保持数据新鲜
- 📊 可预测的API消耗

---

## ⏰ 触发时间表

| 数据类型 | 触发时间 | 频率 | 示例 |
|---------|---------|------|------|
| 1分钟K线 | 整5分钟 | 每5分钟 | 12:00、12:05、12:10... |
| 日K线 | 凌晨2点 | 每24小时 | 每天02:00 |
| 周K线 | 凌晨2点 | 每24小时 | 每天02:00 |

---

## 📊 API调用次数计算

### 10只自选股示例

**每次1分钟K更新**：
- API调用：10次（每只股票1次）
- 耗时：10秒（每只间隔1秒）

**每天总计**：
- 1分钟K：288次触发 × 10只 = 2,880次
- 日K/周K：20次
- **合计：约2,900次/天**

**Tushare限制**：
- 免费用户：200次/分钟
- 我们的使用：10次/5分钟 = 2次/分钟 ✅

---

## 🚨 常见错误处理

### 错误1：频率限制
```
抱歉，您每分钟最多访问该接口2次
```

**原因**：手动点击"更新数据"过于频繁

**解决**：
1. 等待1分钟后再试
2. 使用数据库缓存数据
3. 不要频繁点击更新按钮

### 错误2：权限不足
```
权限不足，无法获取1分钟K线数据
```

**原因**：Tushare免费用户无分钟数据权限

**解决**：
1. 访问 [Tushare积分获取](https://tushare.pro/document/1?doc_id=13)
2. 完成任务提升积分
3. 或只使用日K/周K功能

### 错误3：无数据显示
```
K线图为空
```

**原因**：数据库无缓存，定时任务尚未触发

**解决**：
1. 手动点击"更新数据"（首次必须）
2. 等待下一个整5分钟自动更新
3. 检查股票代码是否正确

---

## 💡 最佳实践

### ✅ 推荐做法

1. **首次使用**：手动更新获取初始数据
2. **日常使用**：依赖定时任务自动更新
3. **偶尔手动更新**：需要最新数据时点击更新
4. **控制自选股数量**：建议<10只

### ❌ 避免做法

1. ❌ 频繁点击"更新数据"按钮
2. ❌ 短时间内切换大量股票
3. ❌ 添加过多自选股（>20只）
4. ❌ 在非交易时段频繁更新

---

## 🛠️ 故障排查

### 检查定时任务是否运行

**方法1：查看终端日志**
```bash
✅ 定时任务已启动（按北京时间整点触发）
⏰ 触发时间点: 14:00
📊 开始更新1分钟K线数据...
```

**方法2：观察下一个整5分钟**
- 当前时间：14:03
- 等待到：14:05
- 查看终端是否有更新日志

### 检查数据库是否有数据

**方法**：
```bash
cd /Users/sunjie/CodeBuddy/ai_quanti
source venv/bin/activate
python3 -c "
from database import db_manager
result = db_manager.execute_query('SELECT COUNT(*) as cnt FROM stock_minute')
print(f'1分钟K线数据条数: {result[0][\"cnt\"]}')
"
```

---

## 📞 快速联系

遇到问题？查看：
- [完整技术文档](./调试报告9-修复API频率限制问题.md)
- [用户使用说明](./股票K线图功能使用说明.md)

---

**文档版本**：v1.0  
**最后更新**：2026年2月18日
