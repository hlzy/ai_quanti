# 持仓变量功能说明

## 更新时间
2026年2月18日

## 功能概览

在AI对话功能中新增了"持仓"和"可用资金"两个变量，用户可以在对话中直接查询账户仓位信息，便于AI综合分析和给出投资建议。

---

## 一、新增变量

### 1.1 持仓变量

**变量名称**：`持仓`

**功能**：获取所有持仓股票的详细信息和汇总数据

**输出内容**：
- 每只持仓股票的详细信息
  - 股票代码
  - 股票名称
  - 持仓数量
  - 成本价
  - 当前价
  - 市值
  - 盈亏金额
  - 盈亏比例
- 汇总统计
  - 持仓数量（共多少只股票）
  - 总市值
  - 总成本
  - 总盈亏

**输出格式示例**：
```
股票代码	股票名称	持仓数量	成本价	当前价	市值	盈亏金额	盈亏比例
688385	复旦微电	3,100	82.64	85.20	264,120.00	7,936.00	9.60%
688313	仕佳光子	2,400	80.27	78.50	188,400.00	-4,248.00	-5.29%

--- 汇总 ---
持仓数量: 2 只
总市值: 452,520.00
总成本: 448,832.00
总盈亏: 3,688.00
```

---

### 1.2 可用资金变量

**变量名称**：`可用资金`

**功能**：获取账户可用现金余额

**输出内容**：
- 当前账户可用资金金额

**输出格式示例**：
```
可用资金: 160,000.00 元
```

---

## 二、使用方法

### 2.1 基础查询

**查看持仓**：
```
查看一下 持仓 情况
```

**查看资金**：
```
我的 可用资金 还有多少？
```

---

### 2.2 综合分析

**仓位评估**：
```
根据 持仓 和 可用资金 判断当前仓位是否合理
```

AI将获取完整的持仓信息和可用资金，分析仓位配置是否合理，并给出调整建议。

---

### 2.3 结合K线数据

**加仓决策**：
```
结合 持仓、可用资金 和 日K__30天_MACD 分析是否适合加仓
```

AI将综合考虑：
- 当前持仓情况（哪些股票、占比多少）
- 可用资金余额（是否有加仓空间）
- 技术形态（MACD是否给出买入信号）

给出综合判断和操作建议。

**减仓时机**：
```
根据 持仓 的盈亏情况和 周K__360天_RSI 判断是否需要减仓
```

AI将分析：
- 各持仓的盈亏比例
- 长期RSI指标（是否超买）

给出减仓建议。

---

## 三、应用场景

### 3.1 仓位管理

**场景**：定期检查仓位配置是否合理

**对话示例**：
```
用户：分析一下我的 持仓 配置，看看是否过于集中

AI：根据您的持仓数据：
    - 复旦微电（688385）：占总市值 58.3%
    - 仕佳光子（688313）：占总市值 41.7%
    
    仓位相对集中在两只科创板股票，建议：
    1. 考虑增加1-2只不同板块的股票分散风险
    2. 当前可用资金 160,000元，占总资产 26.3%，资金利用率合理
```

---

### 3.2 风险控制

**场景**：评估当前风险敞口

**对话示例**：
```
用户：根据 持仓 和市场情况，评估一下当前风险

AI：风险评估：
    - 总持仓市值：452,520元
    - 总盈亏：+3,688元 (+0.82%)
    - 现金比例：26.3%
    
    风险分析：
    1. 仓位适中，有一定安全边际
    2. 建议设置止损位：单只股票跌破成本价5%需要考虑减仓
```

---

### 3.3 加仓决策

**场景**：判断是否有加仓机会

**对话示例**：
```
用户：根据 持仓、可用资金 和当前股票的 日K__30天_MACD 判断是否适合加仓688385

AI：加仓分析：
    【当前仓位】
    - 688385持仓：3,100股，成本82.64元，当前价85.20元
    - 浮盈：+9.60%
    
    【资金情况】
    - 可用资金：160,000元
    - 可加仓空间：充足
    
    【技术形态】
    - MACD：金叉形成，柱状图转正
    - 趋势：上升趋势初期
    
    【建议】
    适合小幅加仓，建议：
    1. 加仓金额：50,000-80,000元（占可用资金30-50%）
    2. 加仓价位：回调至83-84元区间
    3. 控制总仓位不超过总资产的70%
```

---

### 3.4 止盈止损

**场景**：根据盈亏情况调整持仓

**对话示例**：
```
用户：看一下 持仓 中有哪些需要止盈或止损的

AI：持仓盈亏分析：
    【盈利股票】
    - 688385 复旦微电：+9.60%（建议：达到15%可考虑部分止盈）
    
    【亏损股票】
    - 688313 仕佳光子：-5.29%（建议：密切关注，跌破-8%需要考虑止损）
    
    操作建议：
    1. 复旦微电可持有观望，未到止盈位
    2. 仕佳光子需要警惕，建议关注支撑位
```

---

## 四、技术实现

### 4.1 后端实现

**文件**：`services/ai_service.py`

**新增方法**：

1. `_format_positions_data(positions_summary)`
   - 格式化持仓数据为表格字符串
   - 输出每只股票的详细信息和汇总统计

2. `_format_cash_data(cash_balance)`
   - 格式化可用资金数据

3. 在 `_replace_variables()` 中添加变量替换逻辑
   ```python
   # 处理"持仓"变量
   if '持仓' in message:
       positions_summary = position_service.get_portfolio_summary()
       positions_str = self._format_positions_data(positions_summary)
       replaced_message = replaced_message.replace('持仓', f'\n"""\n{positions_str}\n"""')
   
   # 处理"可用资金"变量
   if '可用资金' in message:
       cash_balance = position_service.get_cash_balance()
       cash_str = self._format_cash_data(cash_balance)
       replaced_message = replaced_message.replace('可用资金', f'\n"""\n{cash_str}\n"""')
   ```

### 4.2 数据来源

**持仓数据**：
- 来源：`position_service.get_portfolio_summary()`
- 包含：positions表中的所有持仓记录和汇总统计

**可用资金**：
- 来源：`position_service.get_cash_balance()`
- 包含：cash_balance表中的资金余额

### 4.3 前端更新

**文件**：`templates/index.html`

**变量帮助弹窗更新**：
- 新增"仓位信息"部分
- 添加"持仓"和"可用资金"的说明
- 提供使用示例

---

## 五、使用建议

### 5.1 数据更新

在使用持仓变量前，建议：
1. 在"持仓管理"页面更新价格（点击"更新所有价格"按钮）
2. 确保持仓数据准确反映当前状态
3. 定期更新可用资金余额

### 5.2 组合使用

持仓变量最好与其他变量组合使用：

**组合1：持仓 + K线数据**
```
根据 持仓 和 日K__30天_MACD 制定下周操作计划
```

**组合2：持仓 + 可用资金**
```
分析 持仓 和 可用资金 的配置是否合理
```

**组合3：持仓 + 多只股票K线**
```
对比 持仓 中的688385和688313，结合它们的 日K__30天 判断哪个更值得持有
```

### 5.3 定期回顾

建议每周使用持仓变量进行一次全面回顾：

**每周检查清单**：
```
本周持仓回顾：

1. 查看 持仓 整体情况
2. 检查各股票盈亏比例
3. 评估 可用资金 比例是否合理
4. 结合技术指标判断是否需要调整
```

---

## 六、注意事项

### 6.1 数据准确性
- 持仓数据基于数据库记录，需要手动更新价格
- 盈亏计算基于最新价格，可能与实际成交价有差异

### 6.2 投资建议
- AI给出的建议仅供参考，不构成投资建议
- 请根据自身风险承受能力做出决策

### 6.3 隐私保护
- 持仓数据仅存储在本地数据库
- 不会上传到云端或第三方服务

---

## 七、未来扩展

### 7.1 计划功能
- [ ] 历史持仓对比（对比不同时间的仓位变化）
- [ ] 持仓收益曲线（可视化收益走势）
- [ ] 自动止盈止损提醒
- [ ] 仓位再平衡建议

### 7.2 指标扩展
- [ ] 夏普比率计算
- [ ] 最大回撤分析
- [ ] 收益波动率统计

---

*本文档将随系统升级持续更新*
