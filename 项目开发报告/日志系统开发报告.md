# æ—¥å¿—ç³»ç»ŸåŠŸèƒ½ - å¼€å‘æŠ¥å‘Š

**å¼€å‘æ—¥æœŸ**: 2026-02-18  
**é—®é¢˜**: åˆ†é’ŸKçº¿APIæƒé™ä¸è¶³å¯¼è‡´ç¨‹åºå´©æºƒ  
**è§£å†³**: å®ç°å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿï¼Œè®°å½•é”™è¯¯å¹¶ä¼˜é›…å¤„ç†å¼‚å¸¸

---

## é—®é¢˜æè¿°

ç”¨æˆ·é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š
```
æŠ±æ­‰ï¼Œæ‚¨æ¯åˆ†é’Ÿæœ€å¤šè®¿é—®è¯¥æ¥å£2æ¬¡ï¼Œæƒé™çš„å…·ä½“è¯¦æƒ…è®¿é—®ï¼šhttps://tushare.pro/document/1?doc_id=108ã€‚
è·å–åˆ†é’ŸKçº¿æ•°æ®å¤±è´¥: ERROR.
Traceback (most recent call last):
  File "/Users/sunjie/codebuddy/ai_quanti/services/stock_service.py", line 247, in fetch_minute_data
    ...
OSError: ERROR.
```

æ ¸å¿ƒé—®é¢˜ï¼š
1. Tushareåˆ†é’ŸKçº¿æ¥å£éœ€è¦é«˜çº§æƒé™
2. é”™è¯¯ä¿¡æ¯ä¸å¤Ÿå‹å¥½
3. å¼‚å¸¸å¤„ç†ä¸å®Œå–„ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒ
4. ç¼ºå°‘æ—¥å¿—è®°å½•ï¼Œéš¾ä»¥æ’æŸ¥é—®é¢˜

---

## è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºæ—¥å¿—ç®¡ç†ç³»ç»Ÿ

**æ–‡ä»¶**: `utils/logger.py`

**åŠŸèƒ½**:
- æŒ‰æ—¥æœŸè‡ªåŠ¨åˆ†å‰²æ—¥å¿—æ–‡ä»¶
- æ”¯æŒå¤šä¸ªæ—¥å¿—å™¨ï¼ˆstock_service, ai_serviceç­‰ï¼‰
- æ–‡ä»¶è®°å½•æ‰€æœ‰æ—¥å¿—ï¼Œæ§åˆ¶å°åªæ˜¾ç¤ºWARNINGåŠä»¥ä¸Š
- ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from utils.logger import stock_logger

stock_logger.debug("è°ƒè¯•ä¿¡æ¯")  # ä»…æ–‡ä»¶
stock_logger.info("ä¸€èˆ¬ä¿¡æ¯")   # ä»…æ–‡ä»¶
stock_logger.warning("è­¦å‘Š")    # æ–‡ä»¶+æ§åˆ¶å°
stock_logger.error("é”™è¯¯", exc_info=True)  # æ–‡ä»¶+æ§åˆ¶å°+å †æ ˆ
```

### 2. ä¼˜åŒ–é”™è¯¯å¤„ç†

**ä¿®æ”¹æ–‡ä»¶**: `services/stock_service.py`

**æ”¹è¿›ç‚¹**:

#### (1) æƒé™é”™è¯¯è¯†åˆ«ä¸å‹å¥½æç¤º
```python
except Exception as e:
    error_msg = str(e)
    
    # è¯†åˆ«æƒé™é”™è¯¯
    if 'ERROR.' in error_msg or 'æƒé™' in error_msg:
        stock_logger.warning(
            f"åˆ†é’ŸKçº¿æƒé™ä¸è¶³ - è‚¡ç¥¨: {ts_code}, é¢‘ç‡: {freq}\n"
            f"é”™è¯¯ä¿¡æ¯: {error_msg}\n"
            f"æç¤º: è¯¥æ¥å£éœ€è¦Tushareé«˜çº§æƒé™"
        )
        print(f"  âš ï¸ {ts_code} æ— {freq}åˆ†é’ŸKçº¿æ•°æ®ï¼ˆå¯èƒ½éœ€è¦æƒé™ï¼‰")
    else:
        # å…¶ä»–é”™è¯¯è®°å½•å®Œæ•´å †æ ˆ
        stock_logger.error(
            f"è·å–åˆ†é’ŸKçº¿æ•°æ®å¤±è´¥ - è‚¡ç¥¨: {ts_code}",
            exc_info=True
        )
```

#### (2) APIé™æµä¿æŠ¤
```python
def _rate_limit_check(self, api_name, min_interval=30):
    """APIé™æµæ£€æŸ¥"""
    current_time = time.time()
    last_call = self._last_api_call.get(api_name, 0)
    
    if current_time - last_call < min_interval:
        wait_time = min_interval - (current_time - last_call)
        stock_logger.info(f"APIé™æµ: {api_name} ç­‰å¾… {wait_time:.1f} ç§’")
        time.sleep(wait_time)
    
    self._last_api_call[api_name] = time.time()
```

#### (3) å…³é”®æ“ä½œæ—¥å¿—è®°å½•
- è‚¡ç¥¨ä¿¡æ¯æŸ¥è¯¢
- æ•°æ®è·å–æˆåŠŸ/å¤±è´¥
- APIè°ƒç”¨çŠ¶æ€
- å¼‚å¸¸å †æ ˆè·Ÿè¸ª

### 3. é›†æˆåˆ°æ‰€æœ‰æœåŠ¡

å·²ä¸ºä»¥ä¸‹æœåŠ¡æ·»åŠ æ—¥å¿—æ”¯æŒï¼š
- âœ… `services/stock_service.py` - è‚¡ç¥¨æ•°æ®æœåŠ¡
- âœ… `services/ai_service.py` - AIå¯¹è¯æœåŠ¡
- âœ… `services/position_service.py` - æŒä»“ç®¡ç†
- âœ… `services/watchlist_service.py` - è‡ªé€‰è‚¡ç®¡ç†
- âœ… `app.py` - Flaskä¸»åº”ç”¨

---

## æµ‹è¯•ç»“æœ

### æµ‹è¯•åœºæ™¯1: æƒé™é”™è¯¯å¤„ç†
```bash
$ python test_logging.py

æµ‹è¯•2: è·å–åˆ†é’ŸKçº¿ï¼ˆæµ‹è¯•æƒé™é”™è¯¯å¤„ç†ï¼‰
  âš ï¸ 300058.SZ æ— 1minåˆ†é’ŸKçº¿æ•°æ®ï¼ˆå¯èƒ½éœ€è¦æƒé™ï¼‰
âœ“ æƒé™é”™è¯¯å·²è¢«æ­£ç¡®å¤„ç†ï¼Œæ²¡æœ‰å´©æºƒ
```

**æ—¥å¿—è®°å½•**:
```
2026-02-18 22:36:08 - stock_service - WARNING - åˆ†é’ŸKçº¿æƒé™ä¸è¶³ - è‚¡ç¥¨: 300058.SZ, é¢‘ç‡: 1min
é”™è¯¯ä¿¡æ¯: ERROR.
æç¤º: è¯¥æ¥å£éœ€è¦Tushareé«˜çº§æƒé™ï¼Œè¯¦æƒ…: https://tushare.pro/document/1?doc_id=108
```

### æµ‹è¯•åœºæ™¯2: æ­£å¸¸æ“ä½œæ—¥å¿—
```
2026-02-18 22:36:08 - stock_service - INFO - Stock service initialized successfully
2026-02-18 22:36:08 - stock_service - DEBUG - æŸ¥è¯¢è‚¡ç¥¨ä¿¡æ¯: 688313.SH, ç±»å‹: stock
2026-02-18 22:36:08 - stock_service - INFO - æŸ¥è¯¢åˆ°è‚¡ç¥¨: ä»•ä½³å…‰å­ (688313.SH)
```

### æµ‹è¯•åœºæ™¯3: æ—¥å¿—æ–‡ä»¶åˆ›å»º
```bash
$ ls -lh log/
-rw-r--r-- ai_service_2026-02-18.log (0 bytes)
-rw-r--r-- app_2026-02-18.log (117 bytes)
-rw-r--r-- stock_service_2026-02-18.log (571 bytes)
```

---

## ä¸»è¦æ”¹è¿›

### âœ… 1. ä¸å†å´©æºƒ
- æ‰€æœ‰å¼‚å¸¸éƒ½è¢«æ­£ç¡®æ•è·
- è¿”å›ç©ºæ•°æ®è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
- ç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨å…¶ä»–åŠŸèƒ½

### âœ… 2. å‹å¥½çš„é”™è¯¯æç¤º
**ä¹‹å‰**:
```
Traceback (most recent call last):
  ...
OSError: ERROR.
```

**ç°åœ¨**:
```
âš ï¸ 300058.SZ æ— 1minåˆ†é’ŸKçº¿æ•°æ®ï¼ˆå¯èƒ½éœ€è¦æƒé™ï¼‰
```

### âœ… 3. å®Œæ•´çš„æ—¥å¿—è®°å½•
- æ‰€æœ‰æ“ä½œéƒ½æœ‰æ—¥å¿—è®°å½•
- é”™è¯¯åŒ…å«å®Œæ•´å †æ ˆ
- æŒ‰æ—¥æœŸè‡ªåŠ¨åˆ†å‰²
- ä¾¿äºé—®é¢˜æ’æŸ¥

### âœ… 4. APIé™æµä¿æŠ¤
- è‡ªåŠ¨é™åˆ¶è°ƒç”¨é¢‘ç‡
- é¿å…è§¦å‘Tushareé™åˆ¶
- è®°å½•ç­‰å¾…æ—¶é—´

---

## æ–‡ä»¶å˜æ›´

### æ–°å¢æ–‡ä»¶
```
utils/
â”œâ”€â”€ __init__.py              # å·¥å…·æ¨¡å—åˆå§‹åŒ–
â””â”€â”€ logger.py                # æ—¥å¿—ç®¡ç†å™¨

log/                          # æ—¥å¿—ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â””â”€â”€ *.log                    # æŒ‰æ—¥æœŸåˆ†å‰²çš„æ—¥å¿—æ–‡ä»¶

é¡¹ç›®å¼€å‘æ–‡æ¡£/
â””â”€â”€ æ—¥å¿—ç³»ç»Ÿè¯´æ˜.md          # ä½¿ç”¨æ–‡æ¡£
```

### ä¿®æ”¹æ–‡ä»¶
```
services/stock_service.py     # æ·»åŠ æ—¥å¿—ï¼Œä¼˜åŒ–é”™è¯¯å¤„ç†
services/ai_service.py        # æ·»åŠ æ—¥å¿—
services/position_service.py  # æ·»åŠ æ—¥å¿—
services/watchlist_service.py # æ·»åŠ æ—¥å¿—
app.py                        # æ·»åŠ æ—¥å¿—
.gitignore                    # å¿½ç•¥logç›®å½•
```

---

## ä½¿ç”¨æŒ‡å—

### æŸ¥çœ‹æ—¥å¿—
```bash
# å®æ—¶ç›‘æ§
tail -f log/stock_service_2026-02-18.log

# æœç´¢é”™è¯¯
grep ERROR log/*.log

# æœç´¢æƒé™é—®é¢˜
grep "æƒé™" log/*.log
```

### åœ¨ä»£ç ä¸­ä½¿ç”¨
```python
from utils.logger import stock_logger

try:
    # æ“ä½œ
    stock_logger.info("æ“ä½œæˆåŠŸ")
except Exception as e:
    stock_logger.error("æ“ä½œå¤±è´¥", exc_info=True)
```

---

## åç»­ä¼˜åŒ–å»ºè®®

1. **æ—¥å¿—è½®è½¬**: æ·»åŠ è‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—çš„åŠŸèƒ½
2. **æ—¥å¿—åˆ†æ**: å¯ä»¥æ·»åŠ æ—¥å¿—åˆ†æå·¥å…·ï¼Œç»Ÿè®¡é”™è¯¯é¢‘ç‡
3. **å‘Šè­¦æœºåˆ¶**: å…³é”®é”™è¯¯å¯ä»¥å‘é€é‚®ä»¶/æ¶ˆæ¯é€šçŸ¥
4. **æ€§èƒ½ç›‘æ§**: è®°å½•APIè°ƒç”¨è€—æ—¶ï¼Œåˆ†ææ€§èƒ½ç“¶é¢ˆ

---

## æ€»ç»“

é€šè¿‡å®ç°å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿï¼š
- âœ… è§£å†³äº†æƒé™é”™è¯¯å¯¼è‡´ç¨‹åºå´©æºƒçš„é—®é¢˜
- âœ… æä¾›äº†å‹å¥½çš„é”™è¯¯æç¤º
- âœ… ä¾¿äºé—®é¢˜æ’æŸ¥å’Œè°ƒè¯•
- âœ… ä¸ºåç»­ç›‘æ§å’Œä¼˜åŒ–æ‰“ä¸‹åŸºç¡€

ç°åœ¨å³ä½¿é‡åˆ°APIæƒé™é—®é¢˜ï¼Œç¨‹åºä¹Ÿèƒ½ä¼˜é›…åœ°å¤„ç†å¹¶ç»§ç»­è¿è¡Œï¼ğŸ‰
