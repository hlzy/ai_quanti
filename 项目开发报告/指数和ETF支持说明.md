# 指数和ETF支持说明

## 功能扩展

系统现已支持添加和分析**A股、指数、ETF**三种类型的证券。

## 支持的证券类型

### 1. A股
- **上交所**：6开头（如：600000.SH 浦发银行）
- **深交所**：0、3开头（如：000001.SZ 平安银行，300750.SZ 宁德时代）

### 2. 指数
- **上证指数**：000开头（如：000001.SH 上证指数）
- **深证指数**：399开头（如：399001.SZ 深证成指，399006.SZ 创业板指）

常用指数代码：
- `000001.SH` - 上证指数
- `000300.SH` - 沪深300
- `000016.SH` - 上证50
- `000905.SH` - 中证500
- `399001.SZ` - 深证成指
- `399006.SZ` - 创业板指

### 3. ETF（交易型开放式指数基金）
- **上交所ETF**：51、52开头（如：510300.SH 沪深300ETF，512880.SH 证券ETF）
- **深交所ETF**：15、16开头（如：159915.SZ 创业板ETF）

常用ETF代码：
- `510300.SH` - 沪深300ETF
- `510500.SH` - 中证500ETF
- `512880.SH` - 证券ETF
- `159915.SZ` - 创业板ETF
- `159949.SZ` - 创业板50

## 技术实现

### 代码类型识别
系统自动识别代码类型：
```python
def detect_code_type(stock_code):
    # 指数：000、399开头
    if code.startswith('000') or code.startswith('399'):
        return 'index'
    
    # ETF：51、52、15、16开头
    if code.startswith(('51', '52', '15', '16')):
        return 'fund'
    
    # 默认为A股
    return 'stock'
```

### API接口映射

| 数据类型 | 基本信息 | 日K线 | 周K线 | 分钟K |
|---------|---------|-------|-------|------|
| A股 | `pro.stock_basic()` | `pro.daily()` | `pro.weekly()` | `pro_bar(asset='E')` |
| 指数 | `pro.index_basic()` | `pro.index_daily()` | `pro.index_weekly()` | ❌ 不支持 |
| ETF | `pro.fund_basic()` | `pro.fund_daily()` | 日线聚合 | `pro_bar(asset='FD')` |

**注意事项：**
- 指数不支持分钟K线数据
- ETF周K线通过日K线数据聚合计算

### 数据存储
所有类型共用同一套数据表：
- `stock_daily` - 日K线数据
- `stock_weekly` - 周K线数据
- `stock_minute` - 分钟K线数据
- `stock_indicators` - 技术指标

## 界面展示

### 自选股列表
每个证券显示类型标签：
- **A股** - 蓝色标签
- **指数** - 橙色标签
- **ETF** - 绿色标签

### K线图展示
- **1分钟K**：A股和ETF支持，指数不支持
- **日K**：全部支持
- **周K**：全部支持

## 使用示例

### 添加指数
1. 在自选股输入框输入：`000001` 或 `000001.SH`
2. 点击添加
3. 系统自动识别为上证指数
4. 显示橙色"指数"标签

### 添加ETF
1. 在自选股输入框输入：`510300` 或 `510300.SH`
2. 点击添加
3. 系统自动识别为沪深300ETF
4. 显示绿色"ETF"标签

### 查看K线图
- 选择任意证券
- 自动加载K线图（指数无1分钟K）
- 支持相同的交互操作

## 常见问题

### Q: 为什么指数没有1分钟K线？
A: Tushare API限制，指数类型不提供分钟级数据。

### Q: ETF的周K线数据是否准确？
A: ETF周K线通过日K线数据重采样计算，与实际周K可能有细微差异。

### Q: 如何判断代码类型？
A: 系统根据代码前缀自动判断：
- 000、399 → 指数
- 51、52、15、16 → ETF
- 其他 → A股

## 代码变更

### 核心修改文件
- `services/stock_service.py`：
  - 新增 `detect_code_type()` 方法
  - 修改 `normalize_stock_code()` 逻辑
  - 更新 `get_stock_info()`、`fetch_daily_data()`、`fetch_weekly_data()`、`fetch_minute_data()` 支持多类型
  
- `templates/index.html`：
  - 添加类型标签样式
  - 更新自选股渲染逻辑
  - 修改输入提示文字

## 测试建议

推荐测试以下代码：
1. **指数**：000001（上证指数）、399006（创业板指）
2. **ETF**：510300（沪深300ETF）、159915（创业板ETF）
3. **A股**：600000（浦发银行）、000001（平安银行）

确认：
- 类型标签正确显示
- K线图正常加载
- 持仓管理功能正常
- 数据更新无报错
